{% extends "base.html" %}

{% block title %}실시간 대시보드 - 스마트 빌딩 에너지 관리 시스템{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-tachometer-alt text-primary me-2"></i>
                    실시간 대시보드
                </h1>
                <div class="d-flex align-items-center">
                    <span class="real-time-indicator"></span>
                    <span class="text-muted">실시간 업데이트</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card text-center">
                <div class="card-body">
                    <i class="fas fa-building mb-2" style="font-size: 2rem;"></i>
                    <h4 class="card-title" id="total-buildings">{{ stats.total_buildings }}</h4>
                    <p class="card-text mb-0">관리 건물 수</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card success text-center">
                <div class="card-body">
                    <i class="fas fa-bolt mb-2" style="font-size: 2rem;"></i>
                    <h4 class="card-title" id="current-power">{{ "%.1f"|format(stats.avg_power) }}</h4>
                    <p class="card-text mb-0">현재 전력 사용량 (kWh)</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card warning text-center">
                <div class="card-body">
                    <i class="fas fa-thermometer-half mb-2" style="font-size: 2rem;"></i>
                    <h4 class="card-title" id="current-temp">--</h4>
                    <p class="card-text mb-0">현재 온도 (°C)</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card danger text-center">
                <div class="card-body">
                    <i class="fas fa-users mb-2" style="font-size: 2rem;"></i>
                    <h4 class="card-title" id="current-occupancy">--</h4>
                    <p class="card-text mb-0">현재 공실률 (%)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Real-time Power Consumption -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        실시간 전력 사용량
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="powerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Environmental Data -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-leaf text-success me-2"></i>
                        환경 데이터
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="envChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Charts -->
    <div class="row mb-4">
        <!-- Hourly Pattern -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock text-warning me-2"></i>
                        시간대별 전력 사용 패턴
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-circle text-info me-1"></i>심야시간 (22-06시) |
                            <i class="fas fa-circle text-success me-1"></i>출퇴근 시간대 (06-08시, 18-22시) |
                            <i class="fas fa-circle text-warning me-1"></i>업무시간 (08-18시)
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Building Comparison -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building text-info me-2"></i>
                        건물별 전력 사용량 비교
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="buildingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table text-secondary me-2"></i>
                        최근 데이터
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>건물</th>
                                    <th>전력 사용량 (kWh)</th>
                                    <th>온도 (°C)</th>
                                    <th>습도 (%)</th>
                                    <th>공실률 (%)</th>
                                    <th>상태</th>
                                </tr>
                            </thead>
                            <tbody id="data-table">
                                <!-- 데이터가 JavaScript로 동적 로드됨 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let powerChart, envChart, hourlyChart, buildingChart;

$(document).ready(function() {
    initializeCharts();
    loadRealTimeData();
    
    // 10초마다 실시간 데이터 업데이트
    setInterval(loadRealTimeData, 10000);
});

function initializeCharts() {
    // 실시간 전력 사용량 차트
    const powerCtx = document.getElementById('powerChart').getContext('2d');
    powerChart = new Chart(powerCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '전력 사용량 (kWh)',
                data: [],
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '전력 사용량 (kWh)'
                    }
                }
            }
        }
    });

    // 환경 데이터 차트
    const envCtx = document.getElementById('envChart').getContext('2d');
    envChart = new Chart(envCtx, {
        type: 'doughnut',
        data: {
            labels: ['온도', '습도', '공실률'],
            datasets: [{
                data: [20, 60, 50],
                backgroundColor: ['#e74c3c', '#3498db', '#f39c12']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // 시간대별 패턴 차트 - 완전히 새로운 구현
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    
    // 24시간 고정 데이터 - 툴팁용 라벨
    const hourlyLabels = ['00시-01시', '01시-02시', '02시-03시', '03시-04시', '04시-05시', '05시-06시', '06시-07시', '07시-08시', '08시-09시', '09시-10시', '10시-11시', '11시-12시', '12시-13시', '13시-14시', '14시-15시', '15시-16시', '16시-17시', '17시-18시', '18시-19시', '19시-20시', '20시-21시', '21시-22시', '22시-23시', '23시-00시'];
    const hourlyData = [15, 12, 10, 8, 7, 6, 20, 25, 45, 55, 60, 65, 70, 68, 65, 62, 58, 55, 50, 40, 35, 30, 20, 18];
    const hourlyColors = [
        '#17a2b8', '#17a2b8', '#17a2b8', '#17a2b8', '#17a2b8', '#17a2b8', // 00-05시 (심야)
        '#28a745', '#28a745', // 06-07시 (이동시간)
        '#ffc107', '#ffc107', '#ffc107', '#ffc107', '#ffc107', '#ffc107', '#ffc107', '#ffc107', '#ffc107', '#ffc107', // 08-17시 (업무시간)
        '#ffc107', // 18시 (업무시간)
        '#28a745', '#28a745', '#28a745', // 19-21시 (이동시간)
        '#17a2b8', '#17a2b8' // 22-23시 (심야)
    ];
    
    hourlyChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: hourlyLabels,
            datasets: [{
                label: '평균 전력 사용량',
                data: hourlyData,
                backgroundColor: hourlyColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    mode: 'nearest',
                    intersect: true,
                    callbacks: {
                        title: function(tooltipItems) {
                            const dataIndex = tooltipItems[0].dataIndex;
                            const hour = dataIndex;
                            const nextHour = (hour + 1) % 24;
                            return `${hour.toString().padStart(2, '0')}시-${nextHour.toString().padStart(2, '0')}시`;
                        },
                        label: function(context) {
                            return `평균 전력 사용량: ${context.parsed.y.toFixed(1)} kWh`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 0,
                        minRotation: 0,
                        callback: function(value, index) {
                            // X축에는 간단한 시간만 표시
                            return index.toString().padStart(2, '0');
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 80,
                    min: 0,
                    ticks: {
                        stepSize: 20
                    }
                }
            }
        }
    });

    // 건물별 비교 차트
    const buildingCtx = document.getElementById('buildingChart').getContext('2d');
    buildingChart = new Chart(buildingCtx, {
        type: 'bar',
        data: {
            labels: ['B001', 'B002', 'B003', 'B004', 'B005'],
            datasets: [{
                label: '평균 전력 사용량',
                data: [45, 38, 52, 41, 47],
                backgroundColor: ['#e74c3c', '#3498db', '#f39c12', '#2ecc71', '#9b59b6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function loadRealTimeData() {
    // 실시간 데이터 로드
    $.ajax({
        url: '/api/real_time',
        method: 'GET',
        success: function(data) {
            $('#current-power').text(data.power_consumption.toFixed(1));
            $('#current-temp').text(data.temperature.toFixed(1));
            $('#current-occupancy').text(data.occupancy.toFixed(0));
            
            // 실시간 차트 업데이트
            updateRealTimeChart(data);
        },
        error: function(xhr, status, error) {
            console.log('실시간 데이터 로드 실패:', error);
        }
    });

    // 시계열 데이터 로드
    $.ajax({
        url: '/api/timeseries',
        method: 'GET',
        success: function(data) {
            updateTimeSeriesChart(data);
        },
        error: function(xhr, status, error) {
            console.log('시계열 데이터 로드 실패:', error);
        }
    });
}

function updateRealTimeChart(data) {
    // 환경 데이터 차트 업데이트
    envChart.data.datasets[0].data = [
        data.temperature,
        data.humidity,
        data.occupancy
    ];
    envChart.update();
}

function updateTimeSeriesChart(data) {
    // 전력 사용량 차트 업데이트
    const labels = data.timestamps.map(t => new Date(Date.now() - (100 - t) * 60000).toLocaleTimeString());
    
    powerChart.data.labels = labels;
    powerChart.data.datasets[0].data = data.power_consumption;
    powerChart.update();
}

// 최근 데이터 테이블 업데이트
function updateDataTable() {
    const tableBody = $('#data-table');
    tableBody.empty();
    
    // 샘플 데이터 (실제로는 API에서 가져옴)
    const sampleData = [
        { time: '14:30', building: 'B001', power: 45.2, temp: 22.5, humidity: 65, occupancy: 80, status: '정상' },
        { time: '14:25', building: 'B002', power: 38.7, temp: 21.8, humidity: 62, occupancy: 75, status: '정상' },
        { time: '14:20', building: 'B003', power: 52.1, temp: 23.2, humidity: 68, occupancy: 90, status: '높음' },
        { time: '14:15', building: 'B004', power: 41.3, temp: 22.0, humidity: 64, occupancy: 70, status: '정상' },
        { time: '14:10', building: 'B005', power: 47.8, temp: 22.8, humidity: 66, occupancy: 85, status: '높음' }
    ];
    
    sampleData.forEach(row => {
        const statusClass = row.status === '높음' ? 'text-danger' : 'text-success';
        const tr = `
            <tr>
                <td>${row.time}</td>
                <td>${row.building}</td>
                <td>${row.power}</td>
                <td>${row.temp}</td>
                <td>${row.humidity}</td>
                <td>${row.occupancy}</td>
                <td><span class="${statusClass}">${row.status}</span></td>
            </tr>
        `;
        tableBody.append(tr);
    });
}

// 초기 데이터 테이블 로드
updateDataTable();
</script>
{% endblock %}
