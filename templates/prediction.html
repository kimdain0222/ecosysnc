{% extends "base.html" %}

{% block title %}ì „ë ¥ ì‚¬ìš©ëŸ‰ ì˜ˆì¸¡ - ìŠ¤ë§ˆíŠ¸ ë¹Œë”© ì—ë„ˆì§€ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="fas fa-crystal-ball text-primary me-2"></i>
                ì „ë ¥ ì‚¬ìš©ëŸ‰ ì˜ˆì¸¡
            </h1>
            <p class="text-muted">AI ëª¨ë¸ì„ í™œìš©í•˜ì—¬ ë¯¸ë˜ ì „ë ¥ ì‚¬ìš©ëŸ‰ì„ ì˜ˆì¸¡í•´ë³´ì„¸ìš”</p>
        </div>
    </div>

    <div class="row">
        <!-- Building Selection & Real-time Data -->
        <div class="col-lg-4 mb-4">
            <!-- Building Selection Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        ê±´ë¬¼ ë° ì¸µ ì„ íƒ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="building_id" class="form-label fw-bold">ê±´ë¬¼ ì„ íƒ</label>
                        <select class="form-select form-select-lg" id="building_id" name="building_id" required onchange="updateFloorOptions()">
                            <option value="">ê±´ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="B001">ğŸ¢ B001 - ë³¸ì‚¬ ê±´ë¬¼</option>
                            <option value="B002">ğŸ”¬ B002 - ì—°êµ¬ì†Œ</option>
                            <option value="B003">ğŸ­ B003 - ìƒì‚°ê³µì¥</option>
                            <option value="B004">ğŸ“¦ B004 - ì°½ê³ </option>
                            <option value="B005">ğŸ¢ B005 - ì‚¬ë¬´ì‹¤</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="floor" class="form-label fw-bold">ì¸µ ì„ íƒ</label>
                        <select class="form-select" id="floor" name="floor" required onchange="updateRoomInfo()">
                            <option value="">ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div id="room-info" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="room-description"></span>
                    </div>
                </div>
            </div>

            <!-- Real-time Sensor Data -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sensor me-2"></i>
                        ì‹¤ì‹œê°„ ì„¼ì„œ ë°ì´í„°
                    </h5>
                </div>
                <div class="card-body">
                    <div id="sensor-data" style="display: none;">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="temp-display">--Â°C</div>
                                    <small class="text-muted">ì˜¨ë„</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="hum-display">--%</div>
                                    <small class="text-muted">ìŠµë„</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="occ-display">--ëª…</div>
                                    <small class="text-muted">ì¸ì›</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="power-display">--kWh</div>
                                    <small class="text-muted">ì „ë ¥</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" id="sensor-alert" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="alert-message"></span>
                        </div>
                    </div>
                    
                    <div id="no-sensor-data" class="text-center text-muted">
                        <i class="fas fa-sensor fa-2x mb-2"></i>
                        <p>ê±´ë¬¼ê³¼ ì¸µì„ ì„ íƒí•˜ë©´ ì‹¤ì‹œê°„ ì„¼ì„œ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- Smart Presets -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-magic me-2"></i>
                        ìŠ¤ë§ˆíŠ¸ ì„¤ì •
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="setSmartPreset('office')">
                                <i class="fas fa-building me-1"></i>ì‚¬ë¬´ì‹œê°„
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-success btn-sm w-100" onclick="setSmartPreset('peak')">
                                <i class="fas fa-chart-line me-1"></i>í”¼í¬ì‹œê°„
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-info btn-sm w-100" onclick="setSmartPreset('night')">
                                <i class="fas fa-moon me-1"></i>ì•¼ê°„ì‹œê°„
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-danger btn-sm w-100" onclick="setSmartPreset('weekend')">
                                <i class="fas fa-calendar me-1"></i>ì£¼ë§
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="useCurrentData()">
                            <i class="fas fa-sync me-1"></i>í˜„ì¬ ì„¼ì„œ ë°ì´í„° ì‚¬ìš©
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prediction Form -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>
                        ì˜ˆì¸¡ ì¡°ê±´ ì…ë ¥
                    </h5>
                </div>
                <div class="card-body">
                    <form id="prediction-form">
                        <div class="mb-3">
                            <label for="hour" class="form-label fw-bold">ì˜ˆì¸¡ ì‹œê°„</label>
                            <select class="form-select" id="hour" name="hour" required>
                                <option value="">ì‹œê°„ ì„ íƒ</option>
                                {% for h in range(24) %}
                                <option value="{{ h }}">{{ "%02d"|format(h) }}:00</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="temperature" class="form-label fw-bold">
                                ì˜¨ë„ (Â°C) 
                                <span class="badge bg-warning" id="temp-badge">20Â°C</span>
                            </label>
                            <input type="range" class="form-range" id="temperature" name="temperature" 
                                   min="-10" max="40" value="20" oninput="updateTemperatureValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">-10Â°C</small>
                                <small class="text-muted">40Â°C</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="humidity" class="form-label fw-bold">
                                ìŠµë„ (%) 
                                <span class="badge bg-info" id="hum-badge">60%</span>
                            </label>
                            <input type="range" class="form-range" id="humidity" name="humidity" 
                                   min="0" max="100" value="60" oninput="updateHumidityValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">0%</small>
                                <small class="text-muted">100%</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="occupancy" class="form-label fw-bold">
                                ê³µì‹¤ë¥  (%) 
                                <span class="badge bg-primary" id="occ-badge">50%</span>
                            </label>
                            <input type="range" class="form-range" id="occupancy" name="occupancy" 
                                   min="0" max="100" value="50" oninput="updateOccupancyValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">0%</small>
                                <small class="text-muted">100%</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="season" class="form-label fw-bold">ê³„ì ˆ</label>
                            <select class="form-select" id="season" name="season">
                                <option value="spring">ë´„</option>
                                <option value="summer">ì—¬ë¦„</option>
                                <option value="autumn">ê°€ì„</option>
                                <option value="winter">ê²¨ìš¸</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="day_type" class="form-label fw-bold">ìš”ì¼</label>
                            <select class="form-select" id="day_type" name="day_type">
                                <option value="weekday">í‰ì¼</option>
                                <option value="weekend">ì£¼ë§</option>
                                <option value="holiday">ê³µíœ´ì¼</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-magic me-2"></i>
                            AI ì˜ˆì¸¡ ì‹œì‘
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Prediction Results -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        ì˜ˆì¸¡ ê²°ê³¼
                    </h5>
                </div>
                <div class="card-body">
                    <div id="loading" class="loading text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">AI ëª¨ë¸ì´ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    </div>

                    <div id="prediction-result" style="display: none;">
                        <div class="text-center mb-4">
                            <h4>ì˜ˆìƒ ì „ë ¥ ì‚¬ìš©ëŸ‰</h4>
                            <div id="prediction-value" class="prediction-result display-4 text-primary"></div>
                            <div id="prediction-level" class="mt-2"></div>
                        </div>

                        <!-- Energy Efficiency Score -->
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h6 class="card-title">ì—ë„ˆì§€ íš¨ìœ¨ì„± ì ìˆ˜</h6>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar bg-success" id="efficiency-bar" style="width: 85%"></div>
                                </div>
                                <small class="text-muted">85ì  (ìš°ìˆ˜)</small>
                            </div>
                        </div>

                        <!-- Savings Potential -->
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h6 class="card-title">ì ˆì•½ ê°€ëŠ¥í•œ ì „ë ¥</h6>
                                <div id="savings-potential" class="h5 text-success">12.5 kWh</div>
                                <small class="text-muted">ìµœì í™” ì‹œ ì ˆì•½ ê°€ëŠ¥</small>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        <div class="mt-4">
                            <h6><i class="fas fa-lightbulb text-warning me-2"></i>ì—ë„ˆì§€ ì ˆì•½ ê¶Œì¥ì‚¬í•­</h6>
                            <div id="recommendations" class="list-group list-group-flush">
                                <!-- ê¶Œì¥ì‚¬í•­ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                            </div>
                        </div>
                    </div>

                    <div id="error-message" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="error-text">ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
                    </div>

                    <div id="initial-state" class="text-center text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h5>ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</h5>
                        <p>ê±´ë¬¼ê³¼ ì¡°ê±´ì„ ì„ íƒí•œ í›„ ì˜ˆì¸¡ì„ ì‹œì‘í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Building Management Analytics -->
    <div class="row">
        <!-- Cost Savings Analysis -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-coins me-2"></i>
                        ë¹„ìš© ì ˆì•½ ë¶„ì„
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="h3 text-success" id="annual-savings">â‚©2,250,000</div>
                            <small class="text-muted">ì—°ê°„ ì ˆì•½ì•¡</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-primary" id="monthly-savings">â‚©187,500</div>
                            <small class="text-muted">ì›”ê°„ ì ˆì•½ì•¡</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-warning" id="energy-savings">1,250 kWh</div>
                            <small class="text-muted">ì ˆì•½ ì „ë ¥ëŸ‰</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-info" id="roi-percentage">156%</div>
                            <small class="text-muted">íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµë¥ </small>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: 75%">75% ëª©í‘œ ë‹¬ì„±</div>
                        </div>
                        <small class="text-muted">ì—°ê°„ ì ˆì•½ ëª©í‘œ ëŒ€ë¹„ ë‹¬ì„±ë¥ </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Building Efficiency Rating -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>
                        ê±´ë¬¼ íš¨ìœ¨ì„± ë“±ê¸‰
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-12 mb-3">
                            <div class="h1 text-warning" id="efficiency-grade">A+</div>
                            <small class="text-muted">ì—ë„ˆì§€ íš¨ìœ¨ ë“±ê¸‰</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 text-success" id="carbon-reduction">-15.2%</div>
                                <small class="text-muted">íƒ„ì†Œ ë°°ì¶œ ê°ì†Œ</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 text-info" id="leed-score">85ì </div>
                                <small class="text-muted">LEED ì¸ì¦ ì ìˆ˜</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operational Optimization -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        ìš´ì˜ ìµœì í™”
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-thermometer-half text-danger me-2"></i>ìµœì  ì˜¨ë„ ì„¤ì •</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">ì‚¬ë¬´ì‹¤</small>
                                <div class="h5">22-24Â°C</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">ê³µì¥</small>
                                <div class="h5">18-20Â°C</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-clock text-primary me-2"></i>í”¼í¬ ì‹œê°„ ê´€ë¦¬</h6>
                        <div class="badge bg-warning text-dark me-2">14:00-16:00</div>
                        <small class="text-muted">ìµœëŒ€ ì‚¬ìš©ëŸ‰ ì‹œê°„ëŒ€</small>
                    </div>
                    <div>
                        <h6><i class="fas fa-users text-success me-2"></i>ê³µì‹¤ë¥  ê¸°ë°˜ ì œì–´</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: 85%">85% íš¨ìœ¨ì„±</div>
                        </div>
                        <small class="text-muted">ìë™ ì œì–´ ì‹œìŠ¤í…œ íš¨ìœ¨ì„±</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preventive Maintenance -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>
                        ì˜ˆë°© ì •ë¹„ ê´€ë¦¬
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>ì„¤ë¹„ ìƒíƒœ</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="badge bg-success">ì •ìƒ</div>
                                <small class="text-muted d-block">HVAC ì‹œìŠ¤í…œ</small>
                            </div>
                            <div class="col-6">
                                <div class="badge bg-warning">ì ê²€ í•„ìš”</div>
                                <small class="text-muted d-block">ì¡°ëª… ì‹œìŠ¤í…œ</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-calendar-alt text-primary me-2"></i>ë‹¤ìŒ ì •ë¹„ ì¼ì •</h6>
                        <div class="text-danger">2024-02-15</div>
                        <small class="text-muted">ì¡°ëª… ì‹œìŠ¤í…œ ì ê²€</small>
                    </div>
                    <div>
                        <h6><i class="fas fa-chart-line text-info me-2"></i>ì„¤ë¹„ ìˆ˜ëª… ì˜ˆì¸¡</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-info" style="width: 65%">65%</div>
                        </div>
                        <small class="text-muted">í‰ê·  ì„¤ë¹„ ìˆ˜ëª… ì”ì—¬ìœ¨</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sensor-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c3e50;
}

.prediction-result {
    font-size: 3rem;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.loading {
    padding: 2rem;
}

.card-header {
    border-bottom: none;
}

.form-range::-webkit-slider-thumb {
    background: #007bff;
}

.form-range::-moz-range-thumb {
    background: #007bff;
}

.badge {
    font-size: 0.8rem;
}

#building_id option {
    font-size: 1.1rem;
    padding: 8px;
}

.alert {
    border-radius: 10px;
}
</style>

<script>
// Building and floor data
const buildingData = {
    'B001': {
        name: 'ë³¸ì‚¬ ê±´ë¬¼',
        floors: [
            { floor: 1, room: 'lobby', name: 'ë¡œë¹„', description: 'ê³ ê° ì ‘ìˆ˜ ë° ëŒ€ê¸° ê³µê°„' },
            { floor: 2, room: 'office', name: 'ì‚¬ë¬´ì‹¤', description: 'ì¼ë°˜ ì‚¬ë¬´ ì—…ë¬´ ê³µê°„' },
            { floor: 3, room: 'meeting_room', name: 'íšŒì˜ì‹¤', description: 'íšŒì˜ ë° í”„ë ˆì  í…Œì´ì…˜ ê³µê°„' }
        ]
    },
    'B002': {
        name: 'ì—°êµ¬ì†Œ',
        floors: [
            { floor: 1, room: 'entrance', name: 'ì¶œì…êµ¬', description: 'ë³´ì•ˆ ì¶œì…êµ¬ ë° ì•ˆë‚´ ë°ìŠ¤í¬' },
            { floor: 2, room: 'lab', name: 'ì‹¤í—˜ì‹¤', description: 'ì—°êµ¬ ì‹¤í—˜ ë° ë¶„ì„ ê³µê°„' },
            { floor: 3, room: 'clean_room', name: 'í´ë¦°ë£¸', description: 'ì •ë°€ ì‹¤í—˜ ë° ë¬´ê·  ê³µê°„' }
        ]
    },
    'B003': {
        name: 'ìƒì‚°ê³µì¥',
        floors: [
            { floor: 1, room: 'warehouse', name: 'ì°½ê³ ', description: 'ì›ìì¬ ë° ì™„ì œí’ˆ ë³´ê´€' },
            { floor: 2, room: 'production_line', name: 'ìƒì‚°ë¼ì¸', description: 'ì œì¡° ê³µì • ë° ìƒì‚° ë¼ì¸' },
            { floor: 3, room: 'quality_control', name: 'í’ˆì§ˆê´€ë¦¬', description: 'í’ˆì§ˆ ê²€ì‚¬ ë° ê´€ë¦¬ ê³µê°„' }
        ]
    },
    'B004': {
        name: 'ì°½ê³ ',
        floors: [
            { floor: 1, room: 'storage_area', name: 'ë³´ê´€êµ¬ì—­', description: 'ì¼ë°˜ ìƒí’ˆ ë³´ê´€ ê³µê°„' },
            { floor: 2, room: 'cold_storage', name: 'ëƒ‰ì¥ë³´ê´€', description: 'ëƒ‰ì¥/ëƒ‰ë™ ìƒí’ˆ ë³´ê´€' },
            { floor: 3, room: 'loading_dock', name: 'í•˜ì—­ì¥', description: 'ì¶œí•˜ ë° í•˜ì—­ ì‘ì—… ê³µê°„' }
        ]
    },
    'B005': {
        name: 'ì‚¬ë¬´ì‹¤',
        floors: [
            { floor: 1, room: 'reception', name: 'ì ‘ìˆ˜ì²˜', description: 'ê³ ê° ì ‘ìˆ˜ ë° ì•ˆë‚´' },
            { floor: 2, room: 'open_office', name: 'ì˜¤í”ˆì˜¤í”¼ìŠ¤', description: 'ê°œë°©í˜• ì‚¬ë¬´ ê³µê°„' },
            { floor: 3, room: 'conference_room', name: 'íšŒì˜ì‹¤', description: 'ëŒ€í˜• íšŒì˜ ë° ì„¸ë¯¸ë‚˜ ê³µê°„' }
        ]
    }
};

// Simulated sensor data
const sensorData = {
    'B001': {
        1: { temp: 22, hum: 55, occ: 15, power: 45 },
        2: { temp: 24, hum: 50, occ: 25, power: 78 },
        3: { temp: 23, hum: 52, occ: 8, power: 35 }
    },
    'B002': {
        1: { temp: 21, hum: 48, occ: 5, power: 28 },
        2: { temp: 22, hum: 45, occ: 12, power: 65 },
        3: { temp: 20, hum: 40, occ: 6, power: 42 }
    },
    'B003': {
        1: { temp: 18, hum: 60, occ: 8, power: 55 },
        2: { temp: 25, hum: 55, occ: 18, power: 120 },
        3: { temp: 23, hum: 50, occ: 10, power: 68 }
    },
    'B004': {
        1: { temp: 16, hum: 65, occ: 3, power: 25 },
        2: { temp: 4, hum: 35, occ: 2, power: 85 },
        3: { temp: 15, hum: 70, occ: 5, power: 40 }
    },
    'B005': {
        1: { temp: 23, hum: 53, occ: 12, power: 42 },
        2: { temp: 24, hum: 51, occ: 35, power: 95 },
        3: { temp: 22, hum: 54, occ: 15, power: 58 }
    }
};

function updateFloorOptions() {
    const buildingId = document.getElementById('building_id').value;
    const floorSelect = document.getElementById('floor');
    const roomInfo = document.getElementById('room-info');
    
    floorSelect.innerHTML = '<option value="">ì¸µì„ ì„ íƒí•˜ì„¸ìš”</option>';
    roomInfo.style.display = 'none';
    
    if (buildingId && buildingData[buildingId]) {
        buildingData[buildingId].floors.forEach(floor => {
            const option = document.createElement('option');
            option.value = floor.floor;
            option.textContent = `${floor.floor}ì¸µ - ${floor.name}`;
            floorSelect.appendChild(option);
        });
    }
}

function updateRoomInfo() {
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    const roomInfo = document.getElementById('room-info');
    const roomDescription = document.getElementById('room-description');
    
    if (buildingId && floor && buildingData[buildingId]) {
        const floorData = buildingData[buildingId].floors.find(f => f.floor == floor);
        if (floorData) {
            roomDescription.textContent = floorData.description;
            roomInfo.style.display = 'block';
            updateSensorData(buildingId, floor);
        }
    }
}

function updateSensorData(buildingId, floor) {
    const sensorDataDiv = document.getElementById('sensor-data');
    const noSensorDataDiv = document.getElementById('no-sensor-data');
    const alertDiv = document.getElementById('sensor-alert');
    
    if (sensorData[buildingId] && sensorData[buildingId][floor]) {
        const data = sensorData[buildingId][floor];
        
        const tempDisplay = document.getElementById('temp-display');
        const humDisplay = document.getElementById('hum-display');
        const occDisplay = document.getElementById('occ-display');
        const powerDisplay = document.getElementById('power-display');
        
        if (tempDisplay) tempDisplay.textContent = `${data.temp}Â°C`;
        if (humDisplay) humDisplay.textContent = `${data.hum}%`;
        if (occDisplay) occDisplay.textContent = `${data.occ}ëª…`;
        if (powerDisplay) powerDisplay.textContent = `${data.power}kWh`;
        
        if (sensorDataDiv) sensorDataDiv.style.display = 'block';
        if (noSensorDataDiv) noSensorDataDiv.style.display = 'none';
        
        // Check for alerts
        checkSensorAlerts(buildingId, floor, data);
    } else {
        if (sensorDataDiv) sensorDataDiv.style.display = 'none';
        if (noSensorDataDiv) noSensorDataDiv.style.display = 'block';
        if (alertDiv) alertDiv.style.display = 'none';
    }
}

function checkSensorAlerts(buildingId, floor, data) {
    const alertDiv = document.getElementById('sensor-alert');
    const alertMessage = document.getElementById('alert-message');
    let alerts = [];
    
    // Temperature alerts
    if (data.temp > 28) alerts.push('ì˜¨ë„ê°€ ë†’ìŠµë‹ˆë‹¤');
    if (data.temp < 15) alerts.push('ì˜¨ë„ê°€ ë‚®ìŠµë‹ˆë‹¤');
    
    // Humidity alerts
    if (data.hum > 70) alerts.push('ìŠµë„ê°€ ë†’ìŠµë‹ˆë‹¤');
    if (data.hum < 30) alerts.push('ìŠµë„ê°€ ë‚®ìŠµë‹ˆë‹¤');
    
    // Power alerts
    if (data.power > 100) alerts.push('ì „ë ¥ ì‚¬ìš©ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤');
    
    if (alerts.length > 0) {
        if (alertMessage) alertMessage.textContent = alerts.join(', ');
        if (alertDiv) alertDiv.style.display = 'block';
    } else {
        if (alertDiv) alertDiv.style.display = 'none';
    }
}

function setSmartPreset(type) {
    const buildingId = document.getElementById('building_id').value;
    if (!buildingId) {
        alert('ë¨¼ì € ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }
    
    const presets = {
        'office': { hour: 14, temp: 24, hum: 50, occ: 80, season: 'spring', day_type: 'weekday' },
        'peak': { hour: 18, temp: 26, hum: 60, occ: 90, season: 'summer', day_type: 'weekday' },
        'night': { hour: 2, temp: 20, hum: 45, occ: 10, season: 'winter', day_type: 'weekday' },
        'weekend': { hour: 12, temp: 22, hum: 55, occ: 30, season: 'spring', day_type: 'weekend' }
    };
    
    const preset = presets[type];
    if (preset) {
        const hourElement = document.getElementById('hour');
        const tempElement = document.getElementById('temperature');
        const humElement = document.getElementById('humidity');
        const occElement = document.getElementById('occupancy');
        const seasonElement = document.getElementById('season');
        const dayTypeElement = document.getElementById('day_type');
        
        if (hourElement) hourElement.value = preset.hour;
        if (tempElement) tempElement.value = preset.temp;
        if (humElement) humElement.value = preset.hum;
        if (occElement) occElement.value = preset.occ;
        if (seasonElement) seasonElement.value = preset.season;
        if (dayTypeElement) dayTypeElement.value = preset.day_type;
        
        updateTemperatureValue(preset.temp);
        updateHumidityValue(preset.hum);
        updateOccupancyValue(preset.occ);
    }
}

function useCurrentData() {
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    
    if (!buildingId || !floor) {
        alert('ê±´ë¬¼ê³¼ ì¸µì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }
    
    if (sensorData[buildingId] && sensorData[buildingId][floor]) {
        const data = sensorData[buildingId][floor];
        
        const tempElement = document.getElementById('temperature');
        const humElement = document.getElementById('humidity');
        const occElement = document.getElementById('occupancy');
        const hourElement = document.getElementById('hour');
        
        if (tempElement) tempElement.value = data.temp;
        if (humElement) humElement.value = data.hum;
        if (occElement) occElement.value = Math.round((data.occ / 50) * 100); // Convert to percentage
        
        updateTemperatureValue(data.temp);
        updateHumidityValue(data.hum);
        updateOccupancyValue(Math.round((data.occ / 50) * 100));
        
        // Set current hour
        const now = new Date();
        if (hourElement) hourElement.value = now.getHours();
    }
}

function updateTemperatureValue(value) {
    const tempBadge = document.getElementById('temp-badge');
    if (tempBadge) tempBadge.textContent = `${value}Â°C`;
}

function updateHumidityValue(value) {
    const humBadge = document.getElementById('hum-badge');
    if (humBadge) humBadge.textContent = `${value}%`;
}

function updateOccupancyValue(value) {
    const occBadge = document.getElementById('occ-badge');
    if (occBadge) occBadge.textContent = `${value}%`;
}

// Form submission
document.getElementById('prediction-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    
    if (!buildingId || !floor) {
        alert('ê±´ë¬¼ê³¼ ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }
    
    // Show loading
    const loadingElement = document.getElementById('loading');
    const resultElement = document.getElementById('prediction-result');
    const errorElement = document.getElementById('error-message');
    const initialElement = document.getElementById('initial-state');
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (resultElement) resultElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';
    if (initialElement) initialElement.style.display = 'none';
    
    // Simulate prediction
    setTimeout(() => {
        showPredictionResult();
    }, 2000);
});

function showPredictionResult() {
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    const hour = parseInt(document.getElementById('hour').value) || 12;
    const temp = parseFloat(document.getElementById('temperature').value) || 20;
    const hum = parseFloat(document.getElementById('humidity').value) || 60;
    const occ = parseFloat(document.getElementById('occupancy').value) || 50;
    
    // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
    console.log('Input values:', { buildingId, floor, hour, temp, hum, occ });
    
    // Generate realistic prediction with fallback
    let basePower = 30; // ê¸°ë³¸ê°’
    if (sensorData[buildingId] && sensorData[buildingId][floor] && sensorData[buildingId][floor].power) {
        basePower = sensorData[buildingId][floor].power;
    }
    
    const hourMultiplier = hour >= 8 && hour <= 18 ? 1.2 : 0.8;
    const tempMultiplier = temp > 25 ? 1.1 : 0.9;
    const occMultiplier = occ / 50;
    
    let predictedPower = Math.round(basePower * hourMultiplier * tempMultiplier * occMultiplier);
    
    // ì˜ˆì¸¡ê°’ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³  ê¸°ë³¸ê°’ ì„¤ì •
    if (isNaN(predictedPower) || predictedPower < 0 || predictedPower > 1000) {
        predictedPower = 45; // ê¸°ë³¸ê°’
    }
    
    // ì˜ˆì¸¡ê°’ì´ í•©ë¦¬ì ì¸ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
    if (predictedPower < 5) predictedPower = 5;
    if (predictedPower > 200) predictedPower = 200;
    
    // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
    console.log('Base Power:', basePower, 'Predicted Power:', predictedPower);
    
    // Set power consumption color based on usage level
    let powerColor, efficiency, efficiencyClass;
    
    if (predictedPower <= 10) {
        powerColor = 'text-primary'; // íŒŒë€ìƒ‰ (ë‚®ìŒ)
        efficiency = 'ë§¤ìš° ë‚®ìŒ';
        efficiencyClass = 'primary';
    } else if (predictedPower <= 30) {
        powerColor = 'text-success'; // ì´ˆë¡ìƒ‰ (ë§¤ìš° ë‚®ìŒ)
        efficiency = 'ë‚®ìŒ';
        efficiencyClass = 'success';
    } else if (predictedPower <= 60) {
        powerColor = 'text-warning'; // ë…¸ë€ìƒ‰ (ë³´í†µ)
        efficiency = 'ë³´í†µ';
        efficiencyClass = 'warning';
    } else {
        powerColor = 'text-danger'; // ë¹¨ê°„ìƒ‰ (ë†’ìŒ/ë§¤ìš° ë†’ìŒ)
        efficiency = predictedPower > 100 ? 'ë§¤ìš° ë†’ìŒ' : 'ë†’ìŒ';
        efficiencyClass = 'danger';
    }
    
    // Update prediction value with color - ê°•í™”ëœ ê²€ì¦
    const predictionElement = document.getElementById('prediction-value');
    if (predictionElement) {
        // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
        console.log('Predicted Power:', predictedPower, 'Type:', typeof predictedPower);
        
        // ì˜ˆì¸¡ê°’ì´ ìœ íš¨í•œ ìˆ«ìì¸ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸
        if (typeof predictedPower === 'number' && !isNaN(predictedPower) && predictedPower >= 0 && predictedPower <= 1000) {
            // ìˆ«ìë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë‚ ì§œ í˜•ì‹ì´ ì•„ë‹Œì§€ í™•ì¸
            const powerString = predictedPower.toString();
            if (!powerString.includes('-') && !powerString.includes('/')) {
                predictionElement.textContent = `${predictedPower} kWh`;
                predictionElement.className = `prediction-result display-4 ${powerColor}`;
            } else {
                // ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³´ì´ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
                console.error('Power value looks like date:', predictedPower);
                predictionElement.textContent = `45 kWh`;
                predictionElement.className = `prediction-result display-4 text-warning`;
            }
        } else {
            // ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
            console.error('Invalid predicted power value:', predictedPower);
            predictionElement.textContent = `45 kWh`;
            predictionElement.className = `prediction-result display-4 text-warning`;
        }
    }
    
    // Set efficiency level badge
    const predictionLevelElement = document.getElementById('prediction-level');
    if (predictionLevelElement) {
        // íš¨ìœ¨ì„± ë ˆë²¨ì´ ìœ íš¨í•œì§€ í™•ì¸
        if (efficiency && efficiencyClass) {
            predictionLevelElement.innerHTML = `<span class="badge bg-${efficiencyClass}">${efficiency}</span>`;
        } else {
            predictionLevelElement.innerHTML = `<span class="badge bg-warning">ë³´í†µ</span>`;
        }
    }
    
    // Update efficiency bar - ì™„ì „íˆ ìƒˆë¡œìš´ ë¡œì§
    let efficiencyScore, efficiencyLabel;
    
    // ì „ë ¥ ì‚¬ìš©ëŸ‰ì— ë”°ë¥¸ íš¨ìœ¨ì„± ì ìˆ˜ ê³„ì‚° (ë‚®ì€ ì‚¬ìš©ëŸ‰ = ë†’ì€ íš¨ìœ¨ì„±)
    if (predictedPower <= 10) {
        efficiencyScore = 95;
        efficiencyLabel = 'ë§¤ìš° ë†’ìŒ';
    } else if (predictedPower <= 30) {
        efficiencyScore = 85;
        efficiencyLabel = 'ë†’ìŒ';
    } else if (predictedPower <= 60) {
        efficiencyScore = 70;
        efficiencyLabel = 'ë³´í†µ';
    } else if (predictedPower <= 100) {
        efficiencyScore = 50;
        efficiencyLabel = 'ë‚®ìŒ';
    } else {
        efficiencyScore = 30;
        efficiencyLabel = 'ë§¤ìš° ë‚®ìŒ';
    }
    
    const efficiencyBarElement = document.getElementById('efficiency-bar');
    if (efficiencyBarElement) {
        // íš¨ìœ¨ì„± ì ìˆ˜ê°€ ìœ íš¨í•œì§€ í™•ì¸
        if (typeof efficiencyScore === 'number' && !isNaN(efficiencyScore) && efficiencyScore >= 0 && efficiencyScore <= 100) {
            efficiencyBarElement.style.width = `${efficiencyScore}%`;
            const efficiencyTextElement = efficiencyBarElement.parentElement.nextElementSibling;
            if (efficiencyTextElement) {
                efficiencyTextElement.textContent = `${efficiencyScore}ì  (${efficiencyLabel})`;
            }
        } else {
            // ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
            console.error('Invalid efficiency score:', efficiencyScore);
            efficiencyBarElement.style.width = `70%`;
            const efficiencyTextElement = efficiencyBarElement.parentElement.nextElementSibling;
            if (efficiencyTextElement) {
                efficiencyTextElement.textContent = `70ì  (ë³´í†µ)`;
            }
        }
    }
    
    // Calculate savings
    let savings = Math.max(0, Math.round((basePower * 1.2) - predictedPower));
    
    // ì ˆì•½ëŸ‰ì´ ìœ íš¨í•œì§€ í™•ì¸
    if (isNaN(savings) || savings < 0 || savings > 100) {
        savings = 15; // ê¸°ë³¸ê°’
    }
    
    // ì ˆì•½ëŸ‰ì´ í•©ë¦¬ì ì¸ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
    if (savings > predictedPower) {
        savings = Math.round(predictedPower * 0.3); // ìµœëŒ€ 30% ì ˆì•½
    }
    
    const savingsElement = document.getElementById('savings-potential');
    if (savingsElement) {
        savingsElement.textContent = `${savings} kWh`;
    }
    
    // Generate recommendations
    const recommendations = [];
    if (temp > 25) recommendations.push('ì˜¨ë„ë¥¼ 1-2ë„ ë‚®ì¶°ë³´ì„¸ìš”');
    if (hum > 60) recommendations.push('ìŠµë„ ì¡°ì ˆì„ ê³ ë ¤í•´ë³´ì„¸ìš”');
    if (occ > 80) recommendations.push('ì¸ì› ë¶„ì‚°ì„ ê³ ë ¤í•´ë³´ì„¸ìš”');
    if (hour >= 18) recommendations.push('ì•¼ê°„ ëª¨ë“œë¡œ ì „í™˜ì„ ê³ ë ¤í•´ë³´ì„¸ìš”');
    
    if (recommendations.length === 0) {
        recommendations.push('í˜„ì¬ ì„¤ì •ì´ ìµœì ì…ë‹ˆë‹¤');
    }
    
    const recommendationsDiv = document.getElementById('recommendations');
    if (recommendationsDiv) {
        recommendationsDiv.innerHTML = recommendations.map(rec => 
            `<div class="list-group-item"><i class="fas fa-check text-success me-2"></i>${rec}</div>`
        ).join('');
    }
    
    // Hide loading and show result
    const loadingElement = document.getElementById('loading');
    const resultElement = document.getElementById('prediction-result');
    if (loadingElement) loadingElement.style.display = 'none';
    if (resultElement) resultElement.style.display = 'block';
}

// Initialize building management analytics
document.addEventListener('DOMContentLoaded', function() {
    updateBuildingAnalytics();
    
    // Update analytics every 30 seconds
    setInterval(updateBuildingAnalytics, 30000);
});

function updateBuildingAnalytics() {
    // Fetch real data from API
    fetch('/api/building-analytics')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('API ì˜¤ë¥˜:', data.error);
                return;
            }
            
            // Cost Savings Analysis
            document.getElementById('annual-savings').textContent = `â‚©${data.cost_savings.annual_savings.toLocaleString()}`;
            document.getElementById('monthly-savings').textContent = `â‚©${data.cost_savings.monthly_savings.toLocaleString()}`;
            document.getElementById('energy-savings').textContent = `${data.cost_savings.energy_savings.toLocaleString()} kWh`;
            document.getElementById('roi-percentage').textContent = `${data.cost_savings.roi_percentage}%`;
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${data.cost_savings.goal_achievement}%`;
            progressBar.textContent = `${data.cost_savings.goal_achievement}% ëª©í‘œ ë‹¬ì„±`;
            
            // Building Efficiency Rating
            document.getElementById('efficiency-grade').textContent = data.efficiency_rating.grade;
            document.getElementById('carbon-reduction').textContent = `${data.efficiency_rating.carbon_reduction}%`;
            document.getElementById('leed-score').textContent = `${data.efficiency_rating.leed_score}ì `;
            
            // Operational Optimization
            const controlProgressBar = document.querySelector('.card-body .progress-bar');
            if (controlProgressBar) {
                controlProgressBar.style.width = `${data.operational_optimization.control_efficiency}%`;
                controlProgressBar.textContent = `${data.operational_optimization.control_efficiency}% íš¨ìœ¨ì„±`;
            }
            
            // Update optimal temperature settings
            const officeTempElement = document.querySelector('.col-6 .h5');
            if (officeTempElement) {
                officeTempElement.textContent = data.operational_optimization.optimal_temp_office;
            }
            
            // Preventive Maintenance
            const lifespanProgressBar = document.querySelectorAll('.card-body .progress-bar')[1];
            if (lifespanProgressBar) {
                lifespanProgressBar.style.width = `${data.preventive_maintenance.equipment_lifespan}%`;
            }
            
            // Update maintenance date
            const maintenanceDateElement = document.querySelector('.text-danger');
            if (maintenanceDateElement) {
                maintenanceDateElement.textContent = data.preventive_maintenance.next_maintenance;
            }
            
            // Update equipment status
            const hvacStatusElement = document.querySelector('.badge.bg-success');
            const lightingStatusElement = document.querySelector('.badge.bg-warning');
            if (hvacStatusElement) {
                hvacStatusElement.textContent = data.preventive_maintenance.hvac_status;
            }
            if (lightingStatusElement) {
                lightingStatusElement.textContent = data.preventive_maintenance.lighting_status;
            }
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            // Fallback to static data if API fails
            updateStaticAnalytics();
        });
}

function updateStaticAnalytics() {
    // Fallback static data
    document.getElementById('annual-savings').textContent = 'â‚©2,250,000';
    document.getElementById('monthly-savings').textContent = 'â‚©187,500';
    document.getElementById('energy-savings').textContent = '1,250 kWh';
    document.getElementById('roi-percentage').textContent = '156%';
    
    const progressBar = document.querySelector('.progress-bar');
    progressBar.style.width = '75%';
    progressBar.textContent = '75% ëª©í‘œ ë‹¬ì„±';
    
    document.getElementById('efficiency-grade').textContent = 'A+';
    document.getElementById('carbon-reduction').textContent = '-15.2%';
    document.getElementById('leed-score').textContent = '85ì ';
}
</script>
{% endblock %}
