{% extends "base.html" %}

{% block title %}전력 사용량 예측 - 스마트 빌딩 에너지 관리 시스템{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="fas fa-crystal-ball text-primary me-2"></i>
                전력 사용량 예측
            </h1>
            <p class="text-muted">AI 모델을 활용하여 미래 전력 사용량을 예측해보세요</p>
        </div>
    </div>

    <div class="row">
        <!-- Building Selection & Real-time Data -->
        <div class="col-lg-4 mb-4">
            <!-- Building Selection Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        건물 및 층 선택
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="building_id" class="form-label fw-bold">건물 선택</label>
                        <select class="form-select form-select-lg" id="building_id" name="building_id" required onchange="updateFloorOptions()">
                            <option value="">건물을 선택하세요</option>
                            <option value="B001">🏢 B001 - 본사 건물</option>
                            <option value="B002">🔬 B002 - 연구소</option>
                            <option value="B003">🏭 B003 - 생산공장</option>
                            <option value="B004">📦 B004 - 창고</option>
                            <option value="B005">🏢 B005 - 사무실</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="floor" class="form-label fw-bold">층 선택</label>
                        <select class="form-select" id="floor" name="floor" required onchange="updateRoomInfo()">
                            <option value="">건물을 먼저 선택하세요</option>
                        </select>
                    </div>

                    <div id="room-info" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="room-description"></span>
                    </div>
                </div>
            </div>

            <!-- Real-time Sensor Data -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sensor me-2"></i>
                        실시간 센서 데이터
                    </h5>
                </div>
                <div class="card-body">
                    <div id="sensor-data" style="display: none;">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="temp-display">--°C</div>
                                    <small class="text-muted">온도</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="hum-display">--%</div>
                                    <small class="text-muted">습도</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="occ-display">--명</div>
                                    <small class="text-muted">인원</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="sensor-value" id="power-display">--kWh</div>
                                    <small class="text-muted">전력</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" id="sensor-alert" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="alert-message"></span>
                        </div>
                    </div>
                    
                    <div id="no-sensor-data" class="text-center text-muted">
                        <i class="fas fa-sensor fa-2x mb-2"></i>
                        <p>건물과 층을 선택하면 실시간 센서 데이터가 표시됩니다</p>
                    </div>
                </div>
            </div>

            <!-- Smart Presets -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-magic me-2"></i>
                        스마트 설정
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="setSmartPreset('office')">
                                <i class="fas fa-building me-1"></i>사무시간
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-success btn-sm w-100" onclick="setSmartPreset('peak')">
                                <i class="fas fa-chart-line me-1"></i>피크시간
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-info btn-sm w-100" onclick="setSmartPreset('night')">
                                <i class="fas fa-moon me-1"></i>야간시간
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button class="btn btn-outline-danger btn-sm w-100" onclick="setSmartPreset('weekend')">
                                <i class="fas fa-calendar me-1"></i>주말
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="useCurrentData()">
                            <i class="fas fa-sync me-1"></i>현재 센서 데이터 사용
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prediction Form -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>
                        예측 조건 입력
                    </h5>
                </div>
                <div class="card-body">
                    <form id="prediction-form">
                        <div class="mb-3">
                            <label for="hour" class="form-label fw-bold">예측 시간</label>
                            <select class="form-select" id="hour" name="hour" required>
                                <option value="">시간 선택</option>
                                {% for h in range(24) %}
                                <option value="{{ h }}">{{ "%02d"|format(h) }}:00</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="temperature" class="form-label fw-bold">
                                온도 (°C) 
                                <span class="badge bg-warning" id="temp-badge">20°C</span>
                            </label>
                            <input type="range" class="form-range" id="temperature" name="temperature" 
                                   min="-10" max="40" value="20" oninput="updateTemperatureValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">-10°C</small>
                                <small class="text-muted">40°C</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="humidity" class="form-label fw-bold">
                                습도 (%) 
                                <span class="badge bg-info" id="hum-badge">60%</span>
                            </label>
                            <input type="range" class="form-range" id="humidity" name="humidity" 
                                   min="0" max="100" value="60" oninput="updateHumidityValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">0%</small>
                                <small class="text-muted">100%</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="occupancy" class="form-label fw-bold">
                                공실률 (%) 
                                <span class="badge bg-primary" id="occ-badge">50%</span>
                            </label>
                            <input type="range" class="form-range" id="occupancy" name="occupancy" 
                                   min="0" max="100" value="50" oninput="updateOccupancyValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">0%</small>
                                <small class="text-muted">100%</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="season" class="form-label fw-bold">계절</label>
                            <select class="form-select" id="season" name="season">
                                <option value="spring">봄</option>
                                <option value="summer">여름</option>
                                <option value="autumn">가을</option>
                                <option value="winter">겨울</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="day_type" class="form-label fw-bold">요일</label>
                            <select class="form-select" id="day_type" name="day_type">
                                <option value="weekday">평일</option>
                                <option value="weekend">주말</option>
                                <option value="holiday">공휴일</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-magic me-2"></i>
                            AI 예측 시작
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Prediction Results -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        예측 결과
                    </h5>
                </div>
                <div class="card-body">
                    <div id="loading" class="loading text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">AI 모델이 예측을 수행하고 있습니다...</p>
                    </div>

                    <div id="prediction-result" style="display: none;">
                        <div class="text-center mb-4">
                            <h4>예상 전력 사용량</h4>
                            <div id="prediction-value" class="prediction-result display-4 text-primary"></div>
                            <div id="prediction-level" class="mt-2"></div>
                        </div>

                        <!-- Energy Efficiency Score -->
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h6 class="card-title">에너지 효율성 점수</h6>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar bg-success" id="efficiency-bar" style="width: 85%"></div>
                                </div>
                                <small class="text-muted">85점 (우수)</small>
                            </div>
                        </div>

                        <!-- Savings Potential -->
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center">
                                <h6 class="card-title">절약 가능한 전력</h6>
                                <div id="savings-potential" class="h5 text-success">12.5 kWh</div>
                                <small class="text-muted">최적화 시 절약 가능</small>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        <div class="mt-4">
                            <h6><i class="fas fa-lightbulb text-warning me-2"></i>에너지 절약 권장사항</h6>
                            <div id="recommendations" class="list-group list-group-flush">
                                <!-- 권장사항이 동적으로 추가됨 -->
                            </div>
                        </div>
                    </div>

                    <div id="error-message" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="error-text">예측 중 오류가 발생했습니다.</span>
                    </div>

                    <div id="initial-state" class="text-center text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h5>예측 결과가 여기에 표시됩니다</h5>
                        <p>건물과 조건을 선택한 후 예측을 시작하세요</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Building Management Analytics -->
    <div class="row">
        <!-- Cost Savings Analysis -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-coins me-2"></i>
                        비용 절약 분석
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="h3 text-success" id="annual-savings">₩2,250,000</div>
                            <small class="text-muted">연간 절약액</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-primary" id="monthly-savings">₩187,500</div>
                            <small class="text-muted">월간 절약액</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-warning" id="energy-savings">1,250 kWh</div>
                            <small class="text-muted">절약 전력량</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-info" id="roi-percentage">156%</div>
                            <small class="text-muted">투자 대비 수익률</small>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: 75%">75% 목표 달성</div>
                        </div>
                        <small class="text-muted">연간 절약 목표 대비 달성률</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Building Efficiency Rating -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>
                        건물 효율성 등급
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-12 mb-3">
                            <div class="h1 text-warning" id="efficiency-grade">A+</div>
                            <small class="text-muted">에너지 효율 등급</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 text-success" id="carbon-reduction">-15.2%</div>
                                <small class="text-muted">탄소 배출 감소</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 text-info" id="leed-score">85점</div>
                                <small class="text-muted">LEED 인증 점수</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operational Optimization -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        운영 최적화
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-thermometer-half text-danger me-2"></i>최적 온도 설정</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">사무실</small>
                                <div class="h5">22-24°C</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">공장</small>
                                <div class="h5">18-20°C</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-clock text-primary me-2"></i>피크 시간 관리</h6>
                        <div class="badge bg-warning text-dark me-2">14:00-16:00</div>
                        <small class="text-muted">최대 사용량 시간대</small>
                    </div>
                    <div>
                        <h6><i class="fas fa-users text-success me-2"></i>공실률 기반 제어</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: 85%">85% 효율성</div>
                        </div>
                        <small class="text-muted">자동 제어 시스템 효율성</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preventive Maintenance -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>
                        예방 정비 관리
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>설비 상태</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="badge bg-success">정상</div>
                                <small class="text-muted d-block">HVAC 시스템</small>
                            </div>
                            <div class="col-6">
                                <div class="badge bg-warning">점검 필요</div>
                                <small class="text-muted d-block">조명 시스템</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-calendar-alt text-primary me-2"></i>다음 정비 일정</h6>
                        <div class="text-danger">2024-02-15</div>
                        <small class="text-muted">조명 시스템 점검</small>
                    </div>
                    <div>
                        <h6><i class="fas fa-chart-line text-info me-2"></i>설비 수명 예측</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-info" style="width: 65%">65%</div>
                        </div>
                        <small class="text-muted">평균 설비 수명 잔여율</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sensor-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c3e50;
}

.prediction-result {
    font-size: 3rem;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.loading {
    padding: 2rem;
}

.card-header {
    border-bottom: none;
}

.form-range::-webkit-slider-thumb {
    background: #007bff;
}

.form-range::-moz-range-thumb {
    background: #007bff;
}

.badge {
    font-size: 0.8rem;
}

#building_id option {
    font-size: 1.1rem;
    padding: 8px;
}

.alert {
    border-radius: 10px;
}
</style>

<script>
// Building and floor data
const buildingData = {
    'B001': {
        name: '본사 건물',
        floors: [
            { floor: 1, room: 'lobby', name: '로비', description: '고객 접수 및 대기 공간' },
            { floor: 2, room: 'office', name: '사무실', description: '일반 사무 업무 공간' },
            { floor: 3, room: 'meeting_room', name: '회의실', description: '회의 및 프레젠테이션 공간' }
        ]
    },
    'B002': {
        name: '연구소',
        floors: [
            { floor: 1, room: 'entrance', name: '출입구', description: '보안 출입구 및 안내 데스크' },
            { floor: 2, room: 'lab', name: '실험실', description: '연구 실험 및 분석 공간' },
            { floor: 3, room: 'clean_room', name: '클린룸', description: '정밀 실험 및 무균 공간' }
        ]
    },
    'B003': {
        name: '생산공장',
        floors: [
            { floor: 1, room: 'warehouse', name: '창고', description: '원자재 및 완제품 보관' },
            { floor: 2, room: 'production_line', name: '생산라인', description: '제조 공정 및 생산 라인' },
            { floor: 3, room: 'quality_control', name: '품질관리', description: '품질 검사 및 관리 공간' }
        ]
    },
    'B004': {
        name: '창고',
        floors: [
            { floor: 1, room: 'storage_area', name: '보관구역', description: '일반 상품 보관 공간' },
            { floor: 2, room: 'cold_storage', name: '냉장보관', description: '냉장/냉동 상품 보관' },
            { floor: 3, room: 'loading_dock', name: '하역장', description: '출하 및 하역 작업 공간' }
        ]
    },
    'B005': {
        name: '사무실',
        floors: [
            { floor: 1, room: 'reception', name: '접수처', description: '고객 접수 및 안내' },
            { floor: 2, room: 'open_office', name: '오픈오피스', description: '개방형 사무 공간' },
            { floor: 3, room: 'conference_room', name: '회의실', description: '대형 회의 및 세미나 공간' }
        ]
    }
};

// Simulated sensor data
const sensorData = {
    'B001': {
        1: { temp: 22, hum: 55, occ: 15, power: 45 },
        2: { temp: 24, hum: 50, occ: 25, power: 78 },
        3: { temp: 23, hum: 52, occ: 8, power: 35 }
    },
    'B002': {
        1: { temp: 21, hum: 48, occ: 5, power: 28 },
        2: { temp: 22, hum: 45, occ: 12, power: 65 },
        3: { temp: 20, hum: 40, occ: 6, power: 42 }
    },
    'B003': {
        1: { temp: 18, hum: 60, occ: 8, power: 55 },
        2: { temp: 25, hum: 55, occ: 18, power: 120 },
        3: { temp: 23, hum: 50, occ: 10, power: 68 }
    },
    'B004': {
        1: { temp: 16, hum: 65, occ: 3, power: 25 },
        2: { temp: 4, hum: 35, occ: 2, power: 85 },
        3: { temp: 15, hum: 70, occ: 5, power: 40 }
    },
    'B005': {
        1: { temp: 23, hum: 53, occ: 12, power: 42 },
        2: { temp: 24, hum: 51, occ: 35, power: 95 },
        3: { temp: 22, hum: 54, occ: 15, power: 58 }
    }
};

function updateFloorOptions() {
    const buildingId = document.getElementById('building_id').value;
    const floorSelect = document.getElementById('floor');
    const roomInfo = document.getElementById('room-info');
    
    floorSelect.innerHTML = '<option value="">층을 선택하세요</option>';
    roomInfo.style.display = 'none';
    
    if (buildingId && buildingData[buildingId]) {
        buildingData[buildingId].floors.forEach(floor => {
            const option = document.createElement('option');
            option.value = floor.floor;
            option.textContent = `${floor.floor}층 - ${floor.name}`;
            floorSelect.appendChild(option);
        });
    }
}

function updateRoomInfo() {
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    const roomInfo = document.getElementById('room-info');
    const roomDescription = document.getElementById('room-description');
    
    if (buildingId && floor && buildingData[buildingId]) {
        const floorData = buildingData[buildingId].floors.find(f => f.floor == floor);
        if (floorData) {
            roomDescription.textContent = floorData.description;
            roomInfo.style.display = 'block';
            updateSensorData(buildingId, floor);
        }
    }
}

function updateSensorData(buildingId, floor) {
    const sensorDataDiv = document.getElementById('sensor-data');
    const noSensorDataDiv = document.getElementById('no-sensor-data');
    const alertDiv = document.getElementById('sensor-alert');
    
    if (sensorData[buildingId] && sensorData[buildingId][floor]) {
        const data = sensorData[buildingId][floor];
        
        const tempDisplay = document.getElementById('temp-display');
        const humDisplay = document.getElementById('hum-display');
        const occDisplay = document.getElementById('occ-display');
        const powerDisplay = document.getElementById('power-display');
        
        if (tempDisplay) tempDisplay.textContent = `${data.temp}°C`;
        if (humDisplay) humDisplay.textContent = `${data.hum}%`;
        if (occDisplay) occDisplay.textContent = `${data.occ}명`;
        if (powerDisplay) powerDisplay.textContent = `${data.power}kWh`;
        
        if (sensorDataDiv) sensorDataDiv.style.display = 'block';
        if (noSensorDataDiv) noSensorDataDiv.style.display = 'none';
        
        // Check for alerts
        checkSensorAlerts(buildingId, floor, data);
    } else {
        if (sensorDataDiv) sensorDataDiv.style.display = 'none';
        if (noSensorDataDiv) noSensorDataDiv.style.display = 'block';
        if (alertDiv) alertDiv.style.display = 'none';
    }
}

function checkSensorAlerts(buildingId, floor, data) {
    const alertDiv = document.getElementById('sensor-alert');
    const alertMessage = document.getElementById('alert-message');
    let alerts = [];
    
    // Temperature alerts
    if (data.temp > 28) alerts.push('온도가 높습니다');
    if (data.temp < 15) alerts.push('온도가 낮습니다');
    
    // Humidity alerts
    if (data.hum > 70) alerts.push('습도가 높습니다');
    if (data.hum < 30) alerts.push('습도가 낮습니다');
    
    // Power alerts
    if (data.power > 100) alerts.push('전력 사용량이 높습니다');
    
    if (alerts.length > 0) {
        if (alertMessage) alertMessage.textContent = alerts.join(', ');
        if (alertDiv) alertDiv.style.display = 'block';
    } else {
        if (alertDiv) alertDiv.style.display = 'none';
    }
}

function setSmartPreset(type) {
    const buildingId = document.getElementById('building_id').value;
    if (!buildingId) {
        alert('먼저 건물을 선택해주세요');
        return;
    }
    
    const presets = {
        'office': { hour: 14, temp: 24, hum: 50, occ: 80, season: 'spring', day_type: 'weekday' },
        'peak': { hour: 18, temp: 26, hum: 60, occ: 90, season: 'summer', day_type: 'weekday' },
        'night': { hour: 2, temp: 20, hum: 45, occ: 10, season: 'winter', day_type: 'weekday' },
        'weekend': { hour: 12, temp: 22, hum: 55, occ: 30, season: 'spring', day_type: 'weekend' }
    };
    
    const preset = presets[type];
    if (preset) {
        const hourElement = document.getElementById('hour');
        const tempElement = document.getElementById('temperature');
        const humElement = document.getElementById('humidity');
        const occElement = document.getElementById('occupancy');
        const seasonElement = document.getElementById('season');
        const dayTypeElement = document.getElementById('day_type');
        
        if (hourElement) hourElement.value = preset.hour;
        if (tempElement) tempElement.value = preset.temp;
        if (humElement) humElement.value = preset.hum;
        if (occElement) occElement.value = preset.occ;
        if (seasonElement) seasonElement.value = preset.season;
        if (dayTypeElement) dayTypeElement.value = preset.day_type;
        
        updateTemperatureValue(preset.temp);
        updateHumidityValue(preset.hum);
        updateOccupancyValue(preset.occ);
    }
}

function useCurrentData() {
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    
    if (!buildingId || !floor) {
        alert('건물과 층을 먼저 선택해주세요');
        return;
    }
    
    if (sensorData[buildingId] && sensorData[buildingId][floor]) {
        const data = sensorData[buildingId][floor];
        
        const tempElement = document.getElementById('temperature');
        const humElement = document.getElementById('humidity');
        const occElement = document.getElementById('occupancy');
        const hourElement = document.getElementById('hour');
        
        if (tempElement) tempElement.value = data.temp;
        if (humElement) humElement.value = data.hum;
        if (occElement) occElement.value = Math.round((data.occ / 50) * 100); // Convert to percentage
        
        updateTemperatureValue(data.temp);
        updateHumidityValue(data.hum);
        updateOccupancyValue(Math.round((data.occ / 50) * 100));
        
        // Set current hour
        const now = new Date();
        if (hourElement) hourElement.value = now.getHours();
    }
}

function updateTemperatureValue(value) {
    const tempBadge = document.getElementById('temp-badge');
    if (tempBadge) tempBadge.textContent = `${value}°C`;
}

function updateHumidityValue(value) {
    const humBadge = document.getElementById('hum-badge');
    if (humBadge) humBadge.textContent = `${value}%`;
}

function updateOccupancyValue(value) {
    const occBadge = document.getElementById('occ-badge');
    if (occBadge) occBadge.textContent = `${value}%`;
}

// Form submission
document.getElementById('prediction-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    
    if (!buildingId || !floor) {
        alert('건물과 층을 선택해주세요');
        return;
    }
    
    // Show loading
    const loadingElement = document.getElementById('loading');
    const resultElement = document.getElementById('prediction-result');
    const errorElement = document.getElementById('error-message');
    const initialElement = document.getElementById('initial-state');
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (resultElement) resultElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';
    if (initialElement) initialElement.style.display = 'none';
    
    // Simulate prediction
    setTimeout(() => {
        showPredictionResult();
    }, 2000);
});

function showPredictionResult() {
    const buildingId = document.getElementById('building_id').value;
    const floor = document.getElementById('floor').value;
    const hour = parseInt(document.getElementById('hour').value) || 12;
    const temp = parseFloat(document.getElementById('temperature').value) || 20;
    const hum = parseFloat(document.getElementById('humidity').value) || 60;
    const occ = parseFloat(document.getElementById('occupancy').value) || 50;
    
    // 디버깅을 위한 로그 추가
    console.log('Input values:', { buildingId, floor, hour, temp, hum, occ });
    
    // Generate realistic prediction with fallback
    let basePower = 30; // 기본값
    if (sensorData[buildingId] && sensorData[buildingId][floor] && sensorData[buildingId][floor].power) {
        basePower = sensorData[buildingId][floor].power;
    }
    
    const hourMultiplier = hour >= 8 && hour <= 18 ? 1.2 : 0.8;
    const tempMultiplier = temp > 25 ? 1.1 : 0.9;
    const occMultiplier = occ / 50;
    
    let predictedPower = Math.round(basePower * hourMultiplier * tempMultiplier * occMultiplier);
    
    // 예측값이 유효한지 확인하고 기본값 설정
    if (isNaN(predictedPower) || predictedPower < 0 || predictedPower > 1000) {
        predictedPower = 45; // 기본값
    }
    
    // 예측값이 합리적인 범위 내에 있는지 확인
    if (predictedPower < 5) predictedPower = 5;
    if (predictedPower > 200) predictedPower = 200;
    
    // 디버깅을 위한 로그 추가
    console.log('Base Power:', basePower, 'Predicted Power:', predictedPower);
    
    // Set power consumption color based on usage level
    let powerColor, efficiency, efficiencyClass;
    
    if (predictedPower <= 10) {
        powerColor = 'text-primary'; // 파란색 (낮음)
        efficiency = '매우 낮음';
        efficiencyClass = 'primary';
    } else if (predictedPower <= 30) {
        powerColor = 'text-success'; // 초록색 (매우 낮음)
        efficiency = '낮음';
        efficiencyClass = 'success';
    } else if (predictedPower <= 60) {
        powerColor = 'text-warning'; // 노란색 (보통)
        efficiency = '보통';
        efficiencyClass = 'warning';
    } else {
        powerColor = 'text-danger'; // 빨간색 (높음/매우 높음)
        efficiency = predictedPower > 100 ? '매우 높음' : '높음';
        efficiencyClass = 'danger';
    }
    
    // Update prediction value with color - 강화된 검증
    const predictionElement = document.getElementById('prediction-value');
    if (predictionElement) {
        // 디버깅을 위한 로그 추가
        console.log('Predicted Power:', predictedPower, 'Type:', typeof predictedPower);
        
        // 예측값이 유효한 숫자인지 다시 한번 확인
        if (typeof predictedPower === 'number' && !isNaN(predictedPower) && predictedPower >= 0 && predictedPower <= 1000) {
            // 숫자를 문자열로 변환하여 날짜 형식이 아닌지 확인
            const powerString = predictedPower.toString();
            if (!powerString.includes('-') && !powerString.includes('/')) {
                predictionElement.textContent = `${predictedPower} kWh`;
                predictionElement.className = `prediction-result display-4 ${powerColor}`;
            } else {
                // 날짜 형식으로 보이는 경우 기본값 사용
                console.error('Power value looks like date:', predictedPower);
                predictionElement.textContent = `45 kWh`;
                predictionElement.className = `prediction-result display-4 text-warning`;
            }
        } else {
            // 유효하지 않은 경우 기본값 사용
            console.error('Invalid predicted power value:', predictedPower);
            predictionElement.textContent = `45 kWh`;
            predictionElement.className = `prediction-result display-4 text-warning`;
        }
    }
    
    // Set efficiency level badge
    const predictionLevelElement = document.getElementById('prediction-level');
    if (predictionLevelElement) {
        // 효율성 레벨이 유효한지 확인
        if (efficiency && efficiencyClass) {
            predictionLevelElement.innerHTML = `<span class="badge bg-${efficiencyClass}">${efficiency}</span>`;
        } else {
            predictionLevelElement.innerHTML = `<span class="badge bg-warning">보통</span>`;
        }
    }
    
    // Update efficiency bar - 완전히 새로운 로직
    let efficiencyScore, efficiencyLabel;
    
    // 전력 사용량에 따른 효율성 점수 계산 (낮은 사용량 = 높은 효율성)
    if (predictedPower <= 10) {
        efficiencyScore = 95;
        efficiencyLabel = '매우 높음';
    } else if (predictedPower <= 30) {
        efficiencyScore = 85;
        efficiencyLabel = '높음';
    } else if (predictedPower <= 60) {
        efficiencyScore = 70;
        efficiencyLabel = '보통';
    } else if (predictedPower <= 100) {
        efficiencyScore = 50;
        efficiencyLabel = '낮음';
    } else {
        efficiencyScore = 30;
        efficiencyLabel = '매우 낮음';
    }
    
    const efficiencyBarElement = document.getElementById('efficiency-bar');
    if (efficiencyBarElement) {
        // 효율성 점수가 유효한지 확인
        if (typeof efficiencyScore === 'number' && !isNaN(efficiencyScore) && efficiencyScore >= 0 && efficiencyScore <= 100) {
            efficiencyBarElement.style.width = `${efficiencyScore}%`;
            const efficiencyTextElement = efficiencyBarElement.parentElement.nextElementSibling;
            if (efficiencyTextElement) {
                efficiencyTextElement.textContent = `${efficiencyScore}점 (${efficiencyLabel})`;
            }
        } else {
            // 유효하지 않은 경우 기본값 사용
            console.error('Invalid efficiency score:', efficiencyScore);
            efficiencyBarElement.style.width = `70%`;
            const efficiencyTextElement = efficiencyBarElement.parentElement.nextElementSibling;
            if (efficiencyTextElement) {
                efficiencyTextElement.textContent = `70점 (보통)`;
            }
        }
    }
    
    // Calculate savings
    let savings = Math.max(0, Math.round((basePower * 1.2) - predictedPower));
    
    // 절약량이 유효한지 확인
    if (isNaN(savings) || savings < 0 || savings > 100) {
        savings = 15; // 기본값
    }
    
    // 절약량이 합리적인 범위 내에 있는지 확인
    if (savings > predictedPower) {
        savings = Math.round(predictedPower * 0.3); // 최대 30% 절약
    }
    
    const savingsElement = document.getElementById('savings-potential');
    if (savingsElement) {
        savingsElement.textContent = `${savings} kWh`;
    }
    
    // Generate recommendations
    const recommendations = [];
    if (temp > 25) recommendations.push('온도를 1-2도 낮춰보세요');
    if (hum > 60) recommendations.push('습도 조절을 고려해보세요');
    if (occ > 80) recommendations.push('인원 분산을 고려해보세요');
    if (hour >= 18) recommendations.push('야간 모드로 전환을 고려해보세요');
    
    if (recommendations.length === 0) {
        recommendations.push('현재 설정이 최적입니다');
    }
    
    const recommendationsDiv = document.getElementById('recommendations');
    if (recommendationsDiv) {
        recommendationsDiv.innerHTML = recommendations.map(rec => 
            `<div class="list-group-item"><i class="fas fa-check text-success me-2"></i>${rec}</div>`
        ).join('');
    }
    
    // Hide loading and show result
    const loadingElement = document.getElementById('loading');
    const resultElement = document.getElementById('prediction-result');
    if (loadingElement) loadingElement.style.display = 'none';
    if (resultElement) resultElement.style.display = 'block';
}

// Initialize building management analytics
document.addEventListener('DOMContentLoaded', function() {
    updateBuildingAnalytics();
    
    // Update analytics every 30 seconds
    setInterval(updateBuildingAnalytics, 30000);
});

function updateBuildingAnalytics() {
    // Fetch real data from API
    fetch('/api/building-analytics')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('API 오류:', data.error);
                return;
            }
            
            // Cost Savings Analysis
            document.getElementById('annual-savings').textContent = `₩${data.cost_savings.annual_savings.toLocaleString()}`;
            document.getElementById('monthly-savings').textContent = `₩${data.cost_savings.monthly_savings.toLocaleString()}`;
            document.getElementById('energy-savings').textContent = `${data.cost_savings.energy_savings.toLocaleString()} kWh`;
            document.getElementById('roi-percentage').textContent = `${data.cost_savings.roi_percentage}%`;
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${data.cost_savings.goal_achievement}%`;
            progressBar.textContent = `${data.cost_savings.goal_achievement}% 목표 달성`;
            
            // Building Efficiency Rating
            document.getElementById('efficiency-grade').textContent = data.efficiency_rating.grade;
            document.getElementById('carbon-reduction').textContent = `${data.efficiency_rating.carbon_reduction}%`;
            document.getElementById('leed-score').textContent = `${data.efficiency_rating.leed_score}점`;
            
            // Operational Optimization
            const controlProgressBar = document.querySelector('.card-body .progress-bar');
            if (controlProgressBar) {
                controlProgressBar.style.width = `${data.operational_optimization.control_efficiency}%`;
                controlProgressBar.textContent = `${data.operational_optimization.control_efficiency}% 효율성`;
            }
            
            // Update optimal temperature settings
            const officeTempElement = document.querySelector('.col-6 .h5');
            if (officeTempElement) {
                officeTempElement.textContent = data.operational_optimization.optimal_temp_office;
            }
            
            // Preventive Maintenance
            const lifespanProgressBar = document.querySelectorAll('.card-body .progress-bar')[1];
            if (lifespanProgressBar) {
                lifespanProgressBar.style.width = `${data.preventive_maintenance.equipment_lifespan}%`;
            }
            
            // Update maintenance date
            const maintenanceDateElement = document.querySelector('.text-danger');
            if (maintenanceDateElement) {
                maintenanceDateElement.textContent = data.preventive_maintenance.next_maintenance;
            }
            
            // Update equipment status
            const hvacStatusElement = document.querySelector('.badge.bg-success');
            const lightingStatusElement = document.querySelector('.badge.bg-warning');
            if (hvacStatusElement) {
                hvacStatusElement.textContent = data.preventive_maintenance.hvac_status;
            }
            if (lightingStatusElement) {
                lightingStatusElement.textContent = data.preventive_maintenance.lighting_status;
            }
        })
        .catch(error => {
            console.error('데이터 로드 오류:', error);
            // Fallback to static data if API fails
            updateStaticAnalytics();
        });
}

function updateStaticAnalytics() {
    // Fallback static data
    document.getElementById('annual-savings').textContent = '₩2,250,000';
    document.getElementById('monthly-savings').textContent = '₩187,500';
    document.getElementById('energy-savings').textContent = '1,250 kWh';
    document.getElementById('roi-percentage').textContent = '156%';
    
    const progressBar = document.querySelector('.progress-bar');
    progressBar.style.width = '75%';
    progressBar.textContent = '75% 목표 달성';
    
    document.getElementById('efficiency-grade').textContent = 'A+';
    document.getElementById('carbon-reduction').textContent = '-15.2%';
    document.getElementById('leed-score').textContent = '85점';
}
</script>
{% endblock %}
