{% extends "base.html" %}

{% block title %}스마트 전력 관리 시스템 - 건물 관리자용{% endblock %}

{% block extra_css %}
<style>
    /* 알림 애니메이션 */
    @keyframes slideInFromRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutToRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* 알림 컨테이너 스타일 */
    #alert-container {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    
    #alert-container::-webkit-scrollbar {
        width: 6px;
    }
    
    #alert-container::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #alert-container::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
    }
    
    #alert-container::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.5);
    }
    
    /* 다크모드에서 알림 스타일 */
    [data-theme="dark"] #alert-container .alert {
        background-color: var(--light-bg);
        border-color: #404040;
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 📊 실시간 알림 대시보드 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info border-0 shadow-sm" id="smart-alerts" style="display: none;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-3 fs-4"></i>
                    <div class="flex-grow-1">
                        <strong>시스템 알림:</strong> 
                        <span id="alert-content">현재 전력 사용량이 평균보다 12% 높습니다. 즉시 확인이 필요합니다.</span>
                    </div>
                    <button type="button" class="btn-close" onclick="dismissAlert()"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- 🚀 빠른 액션 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-2">
                                <i class="fas fa-bolt text-primary me-2"></i>
                                스마트 전력 관리 시스템
                            </h3>
                            <p class="text-muted mb-0">실시간 AI 예측으로 효율적인 에너지 관리와 비용 절약을 실현하세요</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary btn-sm" onclick="quickPredict()">
                                    <i class="fas fa-zap me-1"></i>빠른 예측
                                </button>
                                <button class="btn btn-success btn-sm" onclick="compareScenarios()">
                                    <i class="fas fa-chart-line me-1"></i>시나리오 비교
                                </button>
                                <button class="btn btn-info btn-sm" onclick="exportReport()">
                                    <i class="fas fa-download me-1"></i>보고서
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📋 메인 컨텐츠 섹션 -->
    <div class="row">
        <!-- 🏢 스마트 건물 선택 -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-gradient text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>건물 선택
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="building_id" class="form-label fw-bold">건물 선택</label>
                            <select class="form-select" id="building_id" name="building_id" required onchange="updateBuildingInfo()">
                                <option value="">건물을 선택하세요</option>
                                <option value="B001">🏢 B001 - 본사 건물</option>
                                <option value="B002">🔬 B002 - 연구소</option>
                                <option value="B003">🏭 B003 - 생산공장</option>
                                <option value="B004">📦 B004 - 창고</option>
                                <option value="B005">🏢 B005 - 사무실</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="floor_id" class="form-label fw-bold">층 선택</label>
                            <select class="form-select" id="floor_id" name="floor_id" required onchange="updateFloorInfo()">
                                <option value="">층을 선택하세요</option>
                                <option value="1">1층</option>
                                <option value="2">2층</option>
                                <option value="3">3층</option>
                                <option value="4">4층</option>
                                <option value="5">5층</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="building-info" class="alert alert-light" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="building-description"></span>
                    </div>

                    <!-- 📊 실시간 센서 현황 -->
                    <div id="sensor-summary" class="mt-3" style="display: none;">
                        <h6 class="fw-bold mb-3">실시간 현황</h6>
                        <div class="row text-center">
                            <div class="col-6 mb-2">
                                <div class="sensor-card p-2 bg-light rounded">
                                    <div class="h5 mb-1" id="current-temp">--°C</div>
                                    <small class="text-muted">온도</small>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="sensor-card p-2 bg-light rounded">
                                    <div class="h5 mb-1" id="current-power">--kWh</div>
                                    <small class="text-muted">전력</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="sensor-card p-2 bg-light rounded">
                                    <div class="h5 mb-1" id="current-hum">--%</div>
                                    <small class="text-muted">습도</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="sensor-card p-2 bg-light rounded">
                                    <div class="h5 mb-1" id="current-occ">--명</div>
                                    <small class="text-muted">인원</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 🔥 스마트 프리셋 -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3">스마트 시나리오</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="setSmartPreset('office')">
                                    <i class="fas fa-business-time me-1"></i>업무시간
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-danger btn-sm w-100" onclick="setSmartPreset('peak')">
                                    <i class="fas fa-fire me-1"></i>피크시간
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info btn-sm w-100" onclick="setSmartPreset('night')">
                                    <i class="fas fa-moon me-1"></i>야간모드
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="setSmartPreset('weekend')">
                                    <i class="fas fa-calendar-week me-1"></i>주말
                                </button>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-success btn-sm w-100 mt-2" onclick="useCurrentData()">
                            <i class="fas fa-sync me-1"></i>현재 데이터 적용
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ⚡ 스마트 예측 폼 -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-gradient text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>예측 설정
                    </h5>
                </div>
                <div class="card-body">
                    <form id="prediction-form">
                        <div class="mb-3">
                            <label for="hour" class="form-label fw-bold">예측 시간</label>
                            <select class="form-select" id="hour" name="hour" required>
                                <option value="">시간 선택</option>
                                {% for h in range(24) %}
                                <option value="{{ h }}">{{ "%02d"|format(h) }}:00</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                온도 설정 
                                <span class="badge bg-primary" id="temp-badge">22°C</span>
                            </label>
                            <input type="range" class="form-range" id="temperature" name="temperature" 
                                   min="15" max="30" value="22" oninput="updateTempValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">15°C</small>
                                <small class="text-muted">30°C</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                습도 설정 
                                <span class="badge bg-info" id="hum-badge">50%</span>
                            </label>
                            <input type="range" class="form-range" id="humidity" name="humidity" 
                                   min="30" max="80" value="50" oninput="updateHumValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">30%</small>
                                <small class="text-muted">80%</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                공실률 
                                <span class="badge bg-warning" id="occ-badge">30%</span>
                            </label>
                            <input type="range" class="form-range" id="occupancy" name="occupancy" 
                                   min="0" max="100" value="30" oninput="updateOccValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">0%</small>
                                <small class="text-muted">100%</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <label for="season" class="form-label fw-bold">계절</label>
                                <select class="form-select" id="season" name="season">
                                    <option value="spring">봄</option>
                                    <option value="summer" selected>여름</option>
                                    <option value="autumn">가을</option>
                                    <option value="winter">겨울</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="day_type" class="form-label fw-bold">요일</label>
                                <select class="form-select" id="day_type" name="day_type">
                                    <option value="weekday" selected>평일</option>
                                    <option value="weekend">주말</option>
                                    <option value="holiday">공휴일</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100 mt-4">
                            <i class="fas fa-magic me-2"></i>
                            AI 예측 실행
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 📈 예측 결과 & 실행 가능한 권장사항 -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-gradient text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>예측 결과 & 권장사항
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 로딩 상태 -->
                    <div id="loading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">AI가 최적의 예측을 계산 중입니다...</p>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">잠시만 기다려주세요...</small>
                    </div>

                    <!-- 예측 결과 -->
                    <div id="prediction-result" style="display: none;">
                        <div class="text-center mb-4">
                            <h4>예상 전력 사용량</h4>
                            <div id="prediction-value" class="display-4 fw-bold mb-2">--</div>
                            <div id="prediction-level" class="mb-3"></div>
                        </div>

                        <!-- 효율성 점수 -->
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center py-3">
                                <h6 class="card-title mb-2">에너지 효율성</h6>
                                <div class="progress progress-lg mb-2">
                                    <div class="progress-bar bg-success" id="efficiency-bar" style="width: 75%">75%</div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">현재 효율성</small>
                                        <div class="h6" id="efficiency-percentage">75%</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">효율 등급</small>
                                        <div class="h6" id="efficiency-grade">B+</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 절약 가능량 -->
                        <div class="card bg-light mb-3">
                            <div class="card-body text-center py-3">
                                <h6 class="card-title mb-2">절약 가능량</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div id="savings-power" class="h5 text-success">8.2 kWh</div>
                                        <small class="text-muted">전력량</small>
                                    </div>
                                    <div class="col-6">
                                        <div id="savings-cost" class="h5 text-success">₩1,230</div>
                                        <small class="text-muted">비용</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 실행 가능한 권장사항 -->
                        <div class="mt-4">
                            <h6 class="fw-bold mb-3"><i class="fas fa-lightbulb text-warning me-2"></i>즉시 실행 가능한 권장사항</h6>
                            <div id="recommendations" class="list-group list-group-flush">
                                <!-- 권장사항이 동적으로 추가됨 -->
                            </div>
                        </div>
                    </div>

                    <!-- 오류 상태 -->
                    <div id="error-message" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="error-text">예측 중 오류가 발생했습니다.</span>
                    </div>

                    <!-- 초기 상태 -->
                    <div id="initial-state" class="text-center py-5 text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h5>AI 예측 결과가 여기에 표시됩니다</h5>
                        <p>건물을 선택하고 조건을 설정한 후 예측을 실행하세요</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 🎯 스마트 에너지 최적화 시나리오 -->
    <div class="row mb-4" id="scenario-comparison" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-gradient text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>스마트 에너지 최적화 시나리오
                    </h5>
                    <small class="text-white-50">AI가 분석한 최적의 에너지 절약 방안을 비교해보세요</small>
                </div>
                <div class="card-body">
                    <!-- 시나리오 선택 탭 -->
                    <ul class="nav nav-tabs mb-4" id="scenarioTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current" type="button" role="tab">
                                <i class="fas fa-cog me-1"></i>현재 운영
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="optimized-tab" data-bs-toggle="tab" data-bs-target="#optimized" type="button" role="tab">
                                <i class="fas fa-magic me-1"></i>AI 최적화
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="eco-tab" data-bs-toggle="tab" data-bs-target="#eco" type="button" role="tab">
                                <i class="fas fa-leaf me-1"></i>에코 모드
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                                <i class="fas fa-rocket me-1"></i>성능 모드
                            </button>
                        </li>
                    </ul>

                    <!-- 시나리오 내용 -->
                    <div class="tab-content" id="scenarioTabContent">
                        <!-- 현재 운영 시나리오 -->
                        <div class="tab-pane fade show active" id="current" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-info-circle me-1"></i>현재 운영 상태
                                    </h6>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-light rounded">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-bolt text-warning me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0" id="current-power">78 kWh</div>
                                                        <small class="text-muted">일일 전력 사용량</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-light rounded">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-won-sign text-success me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0" id="current-cost">₩23,400</div>
                                                        <small class="text-muted">일일 전기요금</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-clipboard-list me-1"></i>현재 운영 설정</h6>
                                        <ul class="mb-0">
                                            <li>HVAC 온도: 22°C (자동 모드)</li>
                                            <li>조명: 80% 밝기 (업무시간 기준)</li>
                                            <li>대기전력: 활성화</li>
                                            <li>인원 감지: 비활성화</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="scenario-efficiency-circle mb-3">
                                            <div class="efficiency-ring">
                                                <span class="efficiency-text">75%</span>
                                            </div>
                                        </div>
                                        <h6 class="text-muted">현재 효율성</h6>
                                        <small class="text-muted">기본 운영 기준</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI 최적화 시나리오 -->
                        <div class="tab-pane fade" id="optimized" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-success mb-3">
                                        <i class="fas fa-robot me-1"></i>AI 권장 최적화 방안
                                    </h6>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-success bg-opacity-10 rounded border border-success">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-bolt text-success me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0 text-success" id="optimized-power">64 kWh</div>
                                                        <small class="text-muted">예상 전력 사용량</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-success bg-opacity-10 rounded border border-success">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-won-sign text-success me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0 text-success" id="optimized-cost">₩19,200</div>
                                                        <small class="text-muted">예상 전기요금</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-check-circle me-1"></i>권장 최적화 설정</h6>
                                        <ul class="mb-0">
                                            <li><strong>HVAC 온도:</strong> 24°C (절약 모드) - <span class="text-success">2°C 상승</span></li>
                                            <li><strong>조명:</strong> 70% 밝기 (자동 조절) - <span class="text-success">10% 절약</span></li>
                                            <li><strong>대기전력:</strong> 자동 차단 - <span class="text-success">스마트 제어</span></li>
                                            <li><strong>인원 감지:</strong> 활성화 - <span class="text-success">자동 조절</span></li>
                                        </ul>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-6">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="h6 text-success mb-1">₩4,200</div>
                                                <small class="text-muted">일일 절약 금액</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="h6 text-success mb-1">18%</div>
                                                <small class="text-muted">절약 비율</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="scenario-efficiency-circle mb-3">
                                            <div class="efficiency-ring optimized">
                                                <span class="efficiency-text">93%</span>
                                            </div>
                                        </div>
                                        <h6 class="text-success">최적화 효율성</h6>
                                        <small class="text-muted">AI 권장 기준</small>
                                        <div class="mt-3">
                                            <button class="btn btn-success btn-sm" onclick="applyOptimization()">
                                                <i class="fas fa-magic me-1"></i>최적화 적용
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 에코 모드 시나리오 -->
                        <div class="tab-pane fade" id="eco" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-warning mb-3">
                                        <i class="fas fa-leaf me-1"></i>최대 절약 모드
                                    </h6>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-warning bg-opacity-10 rounded border border-warning">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-bolt text-warning me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0 text-warning" id="eco-power">59 kWh</div>
                                                        <small class="text-muted">예상 전력 사용량</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-warning bg-opacity-10 rounded border border-warning">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-won-sign text-warning me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0 text-warning" id="eco-cost">₩17,700</div>
                                                        <small class="text-muted">예상 전기요금</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle me-1"></i>극한 절약 설정 (편의성 저하)</h6>
                                        <ul class="mb-0">
                                            <li><strong>HVAC 온도:</strong> 26°C (절약 모드) - <span class="text-warning">4°C 상승</span></li>
                                            <li><strong>조명:</strong> 50% 밝기 (최소 조명) - <span class="text-warning">30% 절약</span></li>
                                            <li><strong>대기전력:</strong> 완전 차단 - <span class="text-warning">수동 제어</span></li>
                                            <li><strong>인원 감지:</strong> 강화 모드 - <span class="text-warning">자동 차단</span></li>
                                        </ul>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-6">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="h6 text-warning mb-1">₩5,700</div>
                                                <small class="text-muted">일일 절약 금액</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="h6 text-warning mb-1">25%</div>
                                                <small class="text-muted">절약 비율</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="scenario-efficiency-circle mb-3">
                                            <div class="efficiency-ring eco">
                                                <span class="efficiency-text">98%</span>
                                            </div>
                                        </div>
                                        <h6 class="text-warning">에코 효율성</h6>
                                        <small class="text-muted">최대 절약 기준</small>
                                        <div class="mt-3">
                                            <button class="btn btn-warning btn-sm" onclick="applyEcoMode()">
                                                <i class="fas fa-leaf me-1"></i>에코 모드 적용
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 성능 모드 시나리오 -->
                        <div class="tab-pane fade" id="performance" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="text-danger mb-3">
                                        <i class="fas fa-rocket me-1"></i>최고 성능 모드
                                    </h6>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-danger bg-opacity-10 rounded border border-danger">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-bolt text-danger me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0 text-danger" id="performance-power">95 kWh</div>
                                                        <small class="text-muted">예상 전력 사용량</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="scenario-stat-card p-3 bg-danger bg-opacity-10 rounded border border-danger">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-won-sign text-danger me-2"></i>
                                                    <div>
                                                        <div class="h5 mb-0 text-danger" id="performance-cost">₩28,500</div>
                                                        <small class="text-muted">예상 전기요금</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                                                         <div class="alert alert-danger bg-danger bg-opacity-10 border border-danger">
                                         <h6><i class="fas fa-fire me-1"></i>최고 성능 설정 (비용 증가)</h6>
                                         <ul class="mb-0">
                                             <li><strong>HVAC 온도:</strong> 20°C (냉방 강화) - <span class="text-danger">2°C 하강</span></li>
                                             <li><strong>조명:</strong> 100% 밝기 (최대 조명) - <span class="text-danger">20% 증가</span></li>
                                             <li><strong>대기전력:</strong> 완전 활성화 - <span class="text-danger">즉시 대기</span></li>
                                             <li><strong>인원 감지:</strong> 비활성화 - <span class="text-danger">수동 제어</span></li>
                                         </ul>
                                     </div>
                                    <div class="row mt-3">
                                        <div class="col-6">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="h6 text-danger mb-1">-₩5,100</div>
                                                <small class="text-muted">추가 비용</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="h6 text-danger mb-1">+22%</div>
                                                <small class="text-muted">사용량 증가</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="scenario-efficiency-circle mb-3">
                                            <div class="efficiency-ring performance">
                                                <span class="efficiency-text">45%</span>
                                            </div>
                                        </div>
                                        <h6 class="text-danger">성능 효율성</h6>
                                        <small class="text-muted">최고 성능 기준</small>
                                        <div class="mt-3">
                                            <button class="btn btn-danger btn-sm" onclick="applyPerformanceMode()">
                                                <i class="fas fa-rocket me-1"></i>성능 모드 적용
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 💰 실시간 비용 분석 -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-won-sign me-2"></i>실시간 비용 분석
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="h3 text-success" id="daily-cost">₩12,450</div>
                            <small class="text-muted">오늘 예상 비용</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-primary" id="monthly-cost">₩373,500</div>
                            <small class="text-muted">이달 예상 비용</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-warning" id="savings-today">₩2,180</div>
                            <small class="text-muted">오늘 절약 가능</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-info" id="efficiency-ratio">85%</div>
                            <small class="text-muted">효율성 비율</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="fw-bold mb-2">월간 절약 목표</h6>
                        <div class="progress progress-lg mb-2">
                            <div class="progress-bar bg-success" id="monthly-goal" style="width: 68%">68% 달성</div>
                        </div>
                        <small class="text-muted">목표: ₩50,000 절약 / 달성: ₩34,000</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>즉시 실행 액션
                    </h5>
                </div>
                <div class="card-body">
                    <div class="action-item mb-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">🌡️ 온도 2도 낮추기</h6>
                                <small class="text-muted">예상 절약: ₩1,200/일</small>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="applyAction('temp_down')">실행</button>
                        </div>
                    </div>
                    
                    <div class="action-item mb-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">💡 불필요한 조명 끄기</h6>
                                <small class="text-muted">예상 절약: ₩800/일</small>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="applyAction('lights_off')">실행</button>
                        </div>
                    </div>
                    
                    <div class="action-item mb-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">⚡ 대기전력 차단</h6>
                                <small class="text-muted">예상 절약: ₩500/일</small>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="applyAction('standby_off')">실행</button>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-primary w-100" onclick="applyAllActions()">
                            <i class="fas fa-magic me-1"></i>모든 권장사항 한번에 적용
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📊 예측 차트 섹션 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-gradient text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>예측 vs 실제 비교 차트
                    </h5>
                </div>
                <div class="card-body">
                    <div id="prediction-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 📈 시간대별 전력 사용량 트렌드 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-gradient text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>시간대별 전력 사용량 트렌드
                    </h5>
                </div>
                <div class="card-body">
                    <div id="trend-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🎨 커스텀 스타일 -->
<style>
.sensor-card {
    transition: all 0.3s ease;
}

.sensor-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.scenario-card {
    transition: all 0.3s ease;
}

.scenario-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.scenario-stat-card {
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.scenario-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.action-item {
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.action-item:hover {
    border-color: #007bff;
    transform: translateY(-1px);
}

.progress-lg {
    height: 25px;
}

.progress-lg .progress-bar {
    line-height: 25px;
    font-size: 0.9rem;
    font-weight: 500;
}

.bg-gradient {
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

/* 효율성 원형 차트 스타일 */
.scenario-efficiency-circle {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto;
}

.efficiency-ring {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #e9ecef 0deg 360deg
    );
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.5s ease;
}

.efficiency-ring::before {
    content: '';
    position: absolute;
    width: 80%;
    height: 80%;
    border-radius: 50%;
    background: white;
    z-index: 1;
}

.efficiency-ring.optimized {
    background: conic-gradient(
        #28a745 0deg 335deg,
        #e9ecef 335deg 360deg
    );
}

.efficiency-ring.eco {
    background: conic-gradient(
        #ffc107 0deg 353deg,
        #e9ecef 353deg 360deg
    );
}

.efficiency-ring.performance {
    background: conic-gradient(
        #dc3545 0deg 162deg,
        #e9ecef 162deg 360deg
    );
}

.efficiency-text {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c3e50;
    z-index: 2;
    position: relative;
}

 /* 다크모드 지원 */
 [data-theme="dark"] .efficiency-ring::before {
     background: #2d2d2d;
 }

 [data-theme="dark"] .efficiency-text {
     color: #ffffff;
 }

 [data-theme="dark"] .scenario-stat-card {
     background-color: #2d2d2d !important;
     border-color: #404040 !important;
 }

 [data-theme="dark"] .scenario-stat-card:hover {
     background-color: #3d3d3d !important;
 }

 /* 성능모드 알림 박스 개선 */
 .alert-danger.bg-danger.bg-opacity-10 {
     background-color: rgba(220, 53, 69, 0.08) !important;
     border-color: rgba(220, 53, 69, 0.3) !important;
     color: #2c3e50;
 }

 [data-theme="dark"] .alert-danger.bg-danger.bg-opacity-10 {
     background-color: rgba(220, 53, 69, 0.15) !important;
     border-color: rgba(220, 53, 69, 0.4) !important;
     color: #ffffff;
 }

 .alert-danger.bg-danger.bg-opacity-10 h6 {
     color: #dc3545 !important;
     font-weight: 600;
 }

 .alert-danger.bg-danger.bg-opacity-10 ul li {
     color: inherit;
     line-height: 1.6;
 }

 .alert-danger.bg-danger.bg-opacity-10 ul li strong {
     color: inherit;
     font-weight: 600;
 }

/* 탭 스타일 개선 */
.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}

.nav-tabs .nav-link.active {
    border-bottom-color: #007bff;
    background-color: rgba(0, 123, 255, 0.1);
    font-weight: 600;
}

/* 애니메이션 효과 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.scenario-stat-card {
    animation: fadeInUp 0.6s ease;
}

.scenario-stat-card:nth-child(2) {
    animation-delay: 0.1s;
}

.scenario-stat-card:nth-child(3) {
    animation-delay: 0.2s;
}

/* 반응형 디자인 */
@media (max-width: 768px) {
    .scenario-efficiency-circle {
        width: 100px;
        height: 100px;
    }
    
    .efficiency-text {
        font-size: 1.2rem;
    }
    
    .nav-tabs .nav-link {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
    }
}
</style>

<!-- 🔧 JavaScript 기능 -->
<script>
// 건물 데이터
const buildingData = {
    'B001': {
        name: '본사 건물',
        floors: 5,
        description: '메인 오피스 건물 - 일반 사무실, 회의실, 로비 포함',
        floorData: {
            1: { name: '로비', sensors: { temp: 22, hum: 55, occ: 15, power: 45 } },
            2: { name: '사무실', sensors: { temp: 24, hum: 50, occ: 25, power: 78 } },
            3: { name: '회의실', sensors: { temp: 23, hum: 52, occ: 8, power: 35 } },
            4: { name: '개별실', sensors: { temp: 24, hum: 51, occ: 12, power: 42 } },
            5: { name: '관리실', sensors: { temp: 23, hum: 53, occ: 5, power: 28 } }
        }
    },
    'B002': {
        name: '연구소',
        floors: 3,
        description: '연구개발 전용 시설 - 실험실, 클린룸, 분석실 포함',
        floorData: {
            1: { name: '출입구', sensors: { temp: 21, hum: 48, occ: 5, power: 28 } },
            2: { name: '실험실', sensors: { temp: 22, hum: 45, occ: 12, power: 65 } },
            3: { name: '클린룸', sensors: { temp: 20, hum: 40, occ: 6, power: 42 } }
        }
    },
    'B003': {
        name: '생산공장',
        floors: 2,
        description: '제조 및 생산 시설 - 생산라인, 품질관리실 포함',
        floorData: {
            1: { name: '창고', sensors: { temp: 18, hum: 60, occ: 8, power: 55 } },
            2: { name: '생산라인', sensors: { temp: 25, hum: 55, occ: 18, power: 120 } }
        }
    },
    'B004': {
        name: '창고',
        floors: 1,
        description: '물류 및 보관 시설 - 일반창고, 냉장보관실 포함',
        floorData: {
            1: { name: '보관구역', sensors: { temp: 16, hum: 65, occ: 3, power: 25 } }
        }
    },
    'B005': {
        name: '사무실',
        floors: 4,
        description: '부서별 사무공간 - 오픈오피스, 개별실, 회의실 포함',
        floorData: {
            1: { name: '접수처', sensors: { temp: 23, hum: 53, occ: 12, power: 42 } },
            2: { name: '오픈오피스', sensors: { temp: 24, hum: 51, occ: 35, power: 95 } },
            3: { name: '회의실', sensors: { temp: 22, hum: 54, occ: 15, power: 58 } },
            4: { name: '개별실', sensors: { temp: 23, hum: 52, occ: 8, power: 38 } }
        }
    }
};

// 실시간 알림 시스템
function showSmartAlert(message, type = 'info') {
    const alertsDiv = document.getElementById('smart-alerts');
    const contentSpan = document.getElementById('alert-content');
    
    contentSpan.textContent = message;
    alertsDiv.className = `alert alert-${type} border-0 shadow-sm`;
    alertsDiv.style.display = 'block';
    
    // 10초 후 자동 숨김
    setTimeout(() => {
        if (alertsDiv.style.display !== 'none') {
            dismissAlert();
        }
    }, 10000);
}

function dismissAlert() {
    document.getElementById('smart-alerts').style.display = 'none';
}

// 건물 정보 업데이트
function updateBuildingInfo() {
    const buildingId = document.getElementById('building_id').value;
    const floorSelect = document.getElementById('floor_id');
    const infoDiv = document.getElementById('building-info');
    const descSpan = document.getElementById('building-description');
    const sensorDiv = document.getElementById('sensor-summary');
    
    if (buildingId && buildingData[buildingId]) {
        const building = buildingData[buildingId];
        
        // 건물 정보 표시
        descSpan.textContent = building.description;
        infoDiv.style.display = 'block';
        
        // 층 선택 옵션 업데이트
        floorSelect.innerHTML = '<option value="">층을 선택하세요</option>';
        for (let i = 1; i <= building.floors; i++) {
            const floorName = building.floorData[i].name;
            floorSelect.innerHTML += `<option value="${i}">${i}층 - ${floorName}</option>`;
        }
        
        // 층 선택 초기화
        floorSelect.value = '';
        
        // 센서 데이터 숨기기 (층 선택 후 표시)
        sensorDiv.style.display = 'none';
        
        // 자동으로 현재 시간 설정
        const now = new Date();
        document.getElementById('hour').value = now.getHours();
        
        showSmartAlert(`${building.name} 선택됨. 층을 선택해주세요.`, 'info');
    } else {
        infoDiv.style.display = 'none';
        sensorDiv.style.display = 'none';
        floorSelect.innerHTML = '<option value="">층을 선택하세요</option>';
    }
}

// 층 정보 업데이트
function updateFloorInfo() {
    const buildingId = document.getElementById('building_id').value;
    const floorId = document.getElementById('floor_id').value;
    const sensorDiv = document.getElementById('sensor-summary');
    
    if (buildingId && floorId && buildingData[buildingId] && buildingData[buildingId].floorData[floorId]) {
        const building = buildingData[buildingId];
        const floor = building.floorData[floorId];
        
        // 센서 데이터 표시
        document.getElementById('current-temp').textContent = `${floor.sensors.temp}°C`;
        document.getElementById('current-power').textContent = `${floor.sensors.power}kWh`;
        document.getElementById('current-hum').textContent = `${floor.sensors.hum}%`;
        document.getElementById('current-occ').textContent = `${floor.sensors.occ}명`;
        sensorDiv.style.display = 'block';
        
        // 스마트 알림 표시
        if (floor.sensors.power > 100) {
            showSmartAlert(`${building.name} ${floorId}층(${floor.name})의 전력 사용량이 높습니다.`, 'warning');
        } else {
            showSmartAlert(`${building.name} ${floorId}층(${floor.name}) 선택됨.`, 'success');
        }
    } else {
        sensorDiv.style.display = 'none';
    }
}

// 스마트 프리셋 설정
function setSmartPreset(type) {
    const buildingId = document.getElementById('building_id').value;
    if (!buildingId) {
        showSmartAlert('먼저 건물을 선택해주세요!', 'warning');
        return;
    }
    
    const presets = {
        'office': { hour: 14, temp: 24, hum: 50, occ: 20 },
        'peak': { hour: 18, temp: 26, hum: 60, occ: 10 },
        'night': { hour: 2, temp: 20, hum: 45, occ: 80 },
        'weekend': { hour: 12, temp: 22, hum: 55, occ: 60 }
    };
    
    const preset = presets[type];
    if (preset) {
        document.getElementById('hour').value = preset.hour;
        document.getElementById('temperature').value = preset.temp;
        document.getElementById('humidity').value = preset.hum;
        document.getElementById('occupancy').value = preset.occ;
        
        updateTempValue(preset.temp);
        updateHumValue(preset.hum);
        updateOccValue(preset.occ);
        
        showSmartAlert(`${type === 'office' ? '업무시간' : type === 'peak' ? '피크시간' : type === 'night' ? '야간모드' : '주말'} 프리셋이 적용되었습니다.`, 'success');
    }
}

// 현재 데이터 사용
function useCurrentData() {
    const buildingId = document.getElementById('building_id').value;
    const floorId = document.getElementById('floor_id').value;
    
    if (!buildingId) {
        showSmartAlert('먼저 건물을 선택해주세요!', 'warning');
        return;
    }
    
    if (!floorId) {
        showSmartAlert('먼저 층을 선택해주세요!', 'warning');
        return;
    }
    
    const building = buildingData[buildingId];
    const floor = building.floorData[floorId];
    
    if (building && floor) {
        document.getElementById('temperature').value = floor.sensors.temp;
        document.getElementById('humidity').value = floor.sensors.hum;
        document.getElementById('occupancy').value = Math.round((floor.sensors.occ / 60) * 100);
        
        updateTempValue(floor.sensors.temp);
        updateHumValue(floor.sensors.hum);
        updateOccValue(Math.round((floor.sensors.occ / 60) * 100));
        
        // 현재 시간 설정
        const now = new Date();
        document.getElementById('hour').value = now.getHours();
        
        showSmartAlert(`${building.name} ${floorId}층(${floor.name})의 현재 센서 데이터가 적용되었습니다.`, 'success');
    }
}

// 값 업데이트 함수들
function updateTempValue(value) {
    document.getElementById('temp-badge').textContent = `${value}°C`;
}

function updateHumValue(value) {
    document.getElementById('hum-badge').textContent = `${value}%`;
}

function updateOccValue(value) {
    document.getElementById('occ-badge').textContent = `${value}%`;
}

// 빠른 예측
function quickPredict() {
    const buildingId = document.getElementById('building_id').value;
    const floorId = document.getElementById('floor_id').value;
    
    if (!buildingId) {
        showSmartAlert('먼저 건물을 선택해주세요!', 'warning');
        return;
    }
    
    if (!floorId) {
        showSmartAlert('먼저 층을 선택해주세요!', 'warning');
        return;
    }
    
    // 현재 데이터로 자동 설정
    useCurrentData();
    
    // 1초 후 예측 실행
    setTimeout(() => {
        document.getElementById('prediction-form').dispatchEvent(new Event('submit'));
    }, 1000);
    
    showSmartAlert('빠른 예측을 시작합니다...', 'info');
}

// 시나리오 비교
function compareScenarios() {
    const buildingId = document.getElementById('building_id').value;
    const floorId = document.getElementById('floor_id').value;
    
    if (!buildingId) {
        showSmartAlert('먼저 건물을 선택해주세요!', 'warning');
        return;
    }
    
    if (!floorId) {
        showSmartAlert('먼저 층을 선택해주세요!', 'warning');
        return;
    }
    
    const comparisonDiv = document.getElementById('scenario-comparison');
    comparisonDiv.style.display = comparisonDiv.style.display === 'none' ? 'block' : 'none';
    
    if (comparisonDiv.style.display === 'block') {
        // 시나리오 데이터 업데이트
        const building = buildingData[buildingId];
        const floor = building.floorData[floorId];
        const currentPower = floor.sensors.power;
        const optimizedPower = Math.round(currentPower * 0.85);
        const savings = currentPower - optimizedPower;
        
        document.getElementById('scenario-current').textContent = `${currentPower} kWh`;
        document.getElementById('scenario-optimized').textContent = `${optimizedPower} kWh`;
        document.getElementById('scenario-savings').textContent = `${savings} kWh`;
        
        showSmartAlert(`${building.name} ${floorId}층(${floor.name}) 시나리오 비교 분석이 표시되었습니다.`, 'info');
    }
}

// 보고서 내보내기
function exportReport() {
    const buildingId = document.getElementById('building_id').value;
    const floorId = document.getElementById('floor_id').value;
    
    if (!buildingId) {
        showSmartAlert('먼저 건물을 선택해주세요!', 'warning');
        return;
    }
    
    if (!floorId) {
        showSmartAlert('먼저 층을 선택해주세요!', 'warning');
        return;
    }
    
    // 간단한 보고서 생성 시뮬레이션
    const building = buildingData[buildingId];
    const floor = building.floorData[floorId];
    const reportData = {
        building: building.name,
        floor: `${floorId}층 - ${floor.name}`,
        timestamp: new Date().toISOString(),
        power: floor.sensors.power,
        efficiency: 75,
        savings: Math.round(floor.sensors.power * 0.15)
    };
    
    // CSV 형태로 다운로드 시뮬레이션
    const csvContent = `건물명,층,시간,전력사용량,효율성,절약가능량
${reportData.building},${reportData.floor},${new Date().toLocaleString()},${reportData.power}kWh,${reportData.efficiency}%,${reportData.savings}kWh`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `energy_report_${buildingId}_${floorId}F_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showSmartAlert(`${building.name} ${floorId}층(${floor.name}) 에너지 보고서가 다운로드되었습니다.`, 'success');
}

// 액션 실행
function applyAction(actionType) {
    const actions = {
        'temp_down': '온도가 2도 낮춰졌습니다.',
        'lights_off': '불필요한 조명이 꺼졌습니다.',
        'standby_off': '대기전력이 차단되었습니다.'
    };
    
    const button = event.target;
    button.disabled = true;
    button.textContent = '실행됨';
    button.classList.remove('btn-success');
    button.classList.add('btn-secondary');
    
    showSmartAlert(actions[actionType], 'success');
}

function applyAllActions() {
    const buttons = document.querySelectorAll('.action-item .btn-success');
    buttons.forEach(button => {
        button.click();
    });
    showSmartAlert('모든 권장사항이 적용되었습니다!', 'success');
}

// 폼 제출 처리
document.getElementById('prediction-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const buildingId = document.getElementById('building_id').value;
    const floorId = document.getElementById('floor_id').value;
    const hour = document.getElementById('hour').value;
    
    if (!buildingId) {
        showSmartAlert('건물을 선택해주세요!', 'warning');
        return;
    }
    
    if (!floorId) {
        showSmartAlert('층을 선택해주세요!', 'warning');
        return;
    }
    
    if (!hour) {
        showSmartAlert('예측 시간을 선택해주세요!', 'warning');
        return;
    }
    
    // UI 상태 변경
    document.getElementById('loading').style.display = 'block';
    document.getElementById('prediction-result').style.display = 'none';
    document.getElementById('error-message').style.display = 'none';
    document.getElementById('initial-state').style.display = 'none';
    
    // 폼 데이터 수집
    const hourValue = parseInt(hour) || 12;
    const temp = parseFloat(document.getElementById('temperature').value) || 22;
    const hum = parseFloat(document.getElementById('humidity').value) || 50;
    const occ = parseFloat(document.getElementById('occupancy').value) || 30;
    
    // 실제 예측 API 호출
    const predictionData = {
        building_id: buildingId,
        hour: hourValue,
        temperature: temp,
        humidity: hum,
        occupancy: occ
    };
    
    fetch('/api/predict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(predictionData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('예측 결과:', data);
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // 효율성 계산
        let efficiency = 85;
        if (data.prediction > 100) efficiency = 60;
        else if (data.prediction > 80) efficiency = 70;
        else if (data.prediction > 60) efficiency = 80;
        
        // 절약량 계산
        const savings = Math.round(data.prediction * 0.15);
        const savingsCost = savings * 150; // kWh당 150원
        
        // 결과 표시
        showPredictionResult({
            power: data.prediction,
            efficiency: efficiency,
            savings: savings,
            savingsCost: savingsCost,
            level: data.level,
            color: data.color
        });
        
        // 실시간 비용 업데이트
        updateCostAnalysis(data.prediction);
        
        // 성공 알림
        showSmartAlert(`예측 완료! 예상 전력 사용량: ${data.prediction} kWh`, 'success');
    })
    .catch(error => {
        console.error('예측 오류:', error);
        
        // 오류 상태 표시
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-text').textContent = `예측 중 오류가 발생했습니다: ${error.message}`;
        
        // 오류 알림
        showSmartAlert(`예측 오류: ${error.message}`, 'danger');
    });
});

function showPredictionResult(data) {
    // 전력 사용량 표시
    document.getElementById('prediction-value').textContent = `${data.power} kWh`;
    
    // 레벨 표시 (서버에서 받은 정보 사용)
    const level = data.level || '보통';
    const levelClass = data.color || 'warning';
    
    document.getElementById('prediction-level').innerHTML = `<span class="badge bg-${levelClass}">${level}</span>`;
    
    // 효율성 표시
    document.getElementById('efficiency-bar').style.width = `${data.efficiency}%`;
    document.getElementById('efficiency-bar').textContent = `${data.efficiency}%`;
    document.getElementById('efficiency-percentage').textContent = `${data.efficiency}%`;
    
    // 등급 계산
    let grade;
    if (data.efficiency >= 85) grade = 'A+';
    else if (data.efficiency >= 75) grade = 'A';
    else if (data.efficiency >= 65) grade = 'B+';
    else if (data.efficiency >= 55) grade = 'B';
    else grade = 'C';
    
    document.getElementById('efficiency-grade').textContent = grade;
    
    // 절약량 표시
    document.getElementById('savings-power').textContent = `${data.savings} kWh`;
    document.getElementById('savings-cost').textContent = `₩${data.savingsCost.toLocaleString()}`;
    
    // 권장사항 생성
    const recommendations = [];
    if (data.power > 80) recommendations.push('에어컨 설정 온도를 1-2도 높여보세요');
    if (data.efficiency < 70) recommendations.push('불필요한 장비의 전원을 차단하세요');
    if (data.power > 100) recommendations.push('피크 시간대 사용량을 분산시켜보세요');
    recommendations.push('LED 조명으로 교체를 검토해보세요');
    
    const recDiv = document.getElementById('recommendations');
    recDiv.innerHTML = recommendations.map(rec => 
        `<div class="list-group-item d-flex align-items-center">
            <i class="fas fa-check-circle text-success me-2"></i>
            <span>${rec}</span>
        </div>`
    ).join('');
    
    // 결과 표시
    document.getElementById('loading').style.display = 'none';
    document.getElementById('prediction-result').style.display = 'block';
}

function updateCostAnalysis(predictedPower) {
    const dailyCost = predictedPower * 24 * 150;
    const monthlyCost = dailyCost * 30;
    const savingsToday = dailyCost * 0.15;
    
    document.getElementById('daily-cost').textContent = `₩${dailyCost.toLocaleString()}`;
    document.getElementById('monthly-cost').textContent = `₩${monthlyCost.toLocaleString()}`;
    document.getElementById('savings-today').textContent = `₩${Math.round(savingsToday).toLocaleString()}`;
}

// 차트 생성 함수들
function createPredictionChart() {
    fetch('/api/prediction/comparison')
        .then(response => response.json())
        .then(data => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            
            const trace1 = {
                x: data.labels,
                y: data.actual_data,
                type: 'scatter',
                mode: 'lines+markers',
                name: '실제 사용량',
                line: { color: '#e74c3c', width: 3 },
                marker: { size: 6 }
            };
            
            const trace2 = {
                x: data.labels,
                y: data.predicted_data,
                type: 'scatter',
                mode: 'lines+markers',
                name: '예측 사용량',
                line: { color: '#3498db', width: 3, dash: 'dash' },
                marker: { size: 6 }
            };
            
            const layout = {
                title: {
                    text: '24시간 예측 vs 실제 전력 사용량 비교',
                    font: { 
                        size: 16,
                        color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50'
                    }
                },
                xaxis: {
                    title: '시간',
                    gridcolor: currentTheme === 'dark' ? '#404040' : '#e9ecef',
                    color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50'
                },
                yaxis: {
                    title: '전력 사용량 (kWh)',
                    gridcolor: currentTheme === 'dark' ? '#404040' : '#e9ecef',
                    color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50'
                },
                paper_bgcolor: currentTheme === 'dark' ? '#1a1a1a' : '#ffffff',
                plot_bgcolor: currentTheme === 'dark' ? '#2d2d2d' : '#f8f9fa',
                font: { color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50' },
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: currentTheme === 'dark' ? '#2d2d2d' : '#ffffff',
                    bordercolor: currentTheme === 'dark' ? '#404040' : '#e9ecef'
                },
                margin: { l: 60, r: 30, t: 60, b: 60 }
            };
            
            Plotly.newPlot('prediction-chart', [trace1, trace2], layout, {responsive: true});
        })
        .catch(error => {
            console.error('차트 생성 오류:', error);
        });
}

function createTrendChart() {
    // 시간대별 전력 사용량 트렌드 데이터 생성
    const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
    const powerData = hours.map(hour => {
        const h = parseInt(hour.split(':')[0]);
        // 시간대별 패턴 (업무시간에 높음)
        let base = 20;
        if (h >= 9 && h <= 18) base = 60; // 업무시간
        else if (h >= 19 && h <= 22) base = 40; // 저녁시간
        else if (h >= 23 || h <= 6) base = 15; // 야간시간
        
        return Math.round(base + Math.random() * 20);
    });
    
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    
    const trace = {
        x: hours,
        y: powerData,
        type: 'scatter',
        mode: 'lines+markers',
        fill: 'tonexty',
        fillcolor: currentTheme === 'dark' ? 'rgba(52, 152, 219, 0.3)' : 'rgba(52, 152, 219, 0.1)',
        line: { 
            color: currentTheme === 'dark' ? '#5dade2' : '#3498db', 
            width: 3 
        },
        marker: { 
            size: 6,
            color: currentTheme === 'dark' ? '#5dade2' : '#3498db'
        },
        name: '전력 사용량'
    };
    
    const layout = {
        title: {
            text: '시간대별 전력 사용량 패턴',
            font: { 
                size: 16,
                color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50'
            }
        },
        xaxis: {
            title: {
                text: '시간',
                font: { color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50' }
            },
            gridcolor: currentTheme === 'dark' ? '#404040' : '#e9ecef',
            color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50',
            zerolinecolor: currentTheme === 'dark' ? '#404040' : '#e9ecef'
        },
        yaxis: {
            title: {
                text: '전력 사용량 (kWh)',
                font: { color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50' }
            },
            gridcolor: currentTheme === 'dark' ? '#404040' : '#e9ecef',
            color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50',
            zerolinecolor: currentTheme === 'dark' ? '#404040' : '#e9ecef'
        },
        paper_bgcolor: currentTheme === 'dark' ? '#1a1a1a' : '#ffffff',
        plot_bgcolor: currentTheme === 'dark' ? '#2d2d2d' : '#f8f9fa',
        font: { color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50' },
        margin: { l: 60, r: 30, t: 60, b: 60 },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: currentTheme === 'dark' ? '#2d2d2d' : '#ffffff',
            bordercolor: currentTheme === 'dark' ? '#404040' : '#e9ecef',
            font: { color: currentTheme === 'dark' ? '#ffffff' : '#2c3e50' }
        }
    };
    
    // 기존 차트가 있으면 완전히 제거하고 새로 생성
    const trendChartDiv = document.getElementById('trend-chart');
    if (trendChartDiv) {
        Plotly.purge('trend-chart');
    }
    
    Plotly.newPlot('trend-chart', [trace], layout, {responsive: true});
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 현재 시간 자동 설정
    const now = new Date();
    document.getElementById('hour').value = now.getHours();
    
    // 계절 자동 설정
    const month = now.getMonth() + 1;
    let season;
    if (month >= 3 && month <= 5) season = 'spring';
    else if (month >= 6 && month <= 8) season = 'summer';
    else if (month >= 9 && month <= 11) season = 'autumn';
    else season = 'winter';
    
    document.getElementById('season').value = season;
    
    // 평일/주말 자동 설정
    const dayOfWeek = now.getDay();
    document.getElementById('day_type').value = (dayOfWeek === 0 || dayOfWeek === 6) ? 'weekend' : 'weekday';
    
    // 차트 생성
    createPredictionChart();
    createTrendChart();
    
    // 환영 메시지
    setTimeout(() => {
        showSmartAlert('스마트 전력 관리 시스템에 오신 것을 환영합니다! 건물을 선택하여 시작하세요.', 'info');
    }, 1000);
});

// 시나리오 적용 함수들
function applyOptimization() {
    showSmartAlert('AI 최적화 설정이 적용되었습니다! HVAC 온도를 24°C로 조정하고 조명을 70%로 설정했습니다.', 'success');
    
    // 시나리오 비교 섹션 표시
    document.getElementById('scenario-comparison').style.display = 'block';
    
    // 최적화 탭 활성화
    const optimizedTab = new bootstrap.Tab(document.getElementById('optimized-tab'));
    optimizedTab.show();
    
    // 애니메이션 효과
    setTimeout(() => {
        document.querySelectorAll('.scenario-stat-card').forEach(card => {
            card.style.animation = 'none';
            card.offsetHeight; // 리플로우 트리거
            card.style.animation = 'fadeInUp 0.6s ease';
        });
    }, 100);
}

function applyEcoMode() {
    showSmartAlert('에코 모드가 적용되었습니다! 최대 절약을 위해 HVAC 온도를 26°C로 조정하고 조명을 50%로 설정했습니다.', 'warning');
    
    // 시나리오 비교 섹션 표시
    document.getElementById('scenario-comparison').style.display = 'block';
    
    // 에코 탭 활성화
    const ecoTab = new bootstrap.Tab(document.getElementById('eco-tab'));
    ecoTab.show();
    
    // 애니메이션 효과
    setTimeout(() => {
        document.querySelectorAll('.scenario-stat-card').forEach(card => {
            card.style.animation = 'none';
            card.offsetHeight; // 리플로우 트리거
            card.style.animation = 'fadeInUp 0.6s ease';
        });
    }, 100);
}

function applyPerformanceMode() {
    showSmartAlert('성능 모드가 적용되었습니다! 최고 성능을 위해 HVAC 온도를 20°C로 조정하고 조명을 100%로 설정했습니다.', 'danger');
    
    // 시나리오 비교 섹션 표시
    document.getElementById('scenario-comparison').style.display = 'block';
    
    // 성능 탭 활성화
    const performanceTab = new bootstrap.Tab(document.getElementById('performance-tab'));
    performanceTab.show();
    
    // 애니메이션 효과
    setTimeout(() => {
        document.querySelectorAll('.scenario-stat-card').forEach(card => {
            card.style.animation = 'none';
            card.offsetHeight; // 리플로우 트리거
            card.style.animation = 'fadeInUp 0.6s ease';
        });
    }, 100);
}

// 즉시 실행 액션 함수들
function applyAction(actionType) {
    const actions = {
        'temp_down': {
            message: 'HVAC 온도를 2도 낮춰서 일일 ₩1,200을 절약했습니다!',
            type: 'success'
        },
        'lights_off': {
            message: '불필요한 조명을 끄고 일일 ₩800을 절약했습니다!',
            type: 'success'
        },
        'standby_off': {
            message: '대기전력을 차단하여 일일 ₩500을 절약했습니다!',
            type: 'success'
        }
    };
    
    const action = actions[actionType];
    if (action) {
        showSmartAlert(action.message, action.type);
        
        // 버튼 상태 변경
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>적용됨';
        button.classList.remove('btn-success');
        button.classList.add('btn-secondary');
        button.disabled = true;
        
        // 3초 후 원래 상태로 복원
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-secondary');
            button.classList.add('btn-success');
            button.disabled = false;
        }, 3000);
    }
}

function applyAllActions() {
    showSmartAlert('모든 권장사항이 적용되었습니다! 일일 총 ₩2,500을 절약할 수 있습니다.', 'success');
    
    // 모든 액션 버튼 상태 변경
    document.querySelectorAll('.action-item .btn-success').forEach(button => {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>적용됨';
        button.classList.remove('btn-success');
        button.classList.add('btn-secondary');
        button.disabled = true;
        
        // 3초 후 원래 상태로 복원
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-secondary');
            button.classList.add('btn-success');
            button.disabled = false;
        }, 3000);
    });
}

// 스마트 알림 함수
function showSmartAlert(message, type = 'info') {
    // 알림 컨테이너가 없으면 생성
    let alertContainer = document.getElementById('alert-container');
    if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.id = 'alert-container';
        alertContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px; max-height: 80vh; overflow-y: auto;';
        document.body.appendChild(alertContainer);
    }
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-2`;
    alertDiv.style.cssText = 'min-width: 300px; animation: slideInFromRight 0.3s ease;';
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // 새로운 알림을 맨 위에 추가
    alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
    
    // 기존 알림들을 아래로 밀어내기
    const existingAlerts = alertContainer.querySelectorAll('.alert');
    existingAlerts.forEach((alert, index) => {
        if (index > 0) { // 첫 번째 알림(새로 추가된 것) 제외
            alert.style.transform = `translateY(${index * 80}px)`;
            alert.style.transition = 'transform 0.3s ease';
        }
    });
    
    // 5초 후 자동 제거
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.animation = 'slideOutToRight 0.3s ease';
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                    // 남은 알림들의 위치 재조정
                    const remainingAlerts = alertContainer.querySelectorAll('.alert');
                    remainingAlerts.forEach((alert, index) => {
                        alert.style.transform = `translateY(${index * 80}px)`;
                    });
                }
            }, 300);
        }
    }, 5000);
    
    // 닫기 버튼 이벤트
    const closeBtn = alertDiv.querySelector('.btn-close');
    closeBtn.addEventListener('click', () => {
        alertDiv.style.animation = 'slideOutToRight 0.3s ease';
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
                // 남은 알림들의 위치 재조정
                const remainingAlerts = alertContainer.querySelectorAll('.alert');
                remainingAlerts.forEach((alert, index) => {
                    alert.style.transform = `translateY(${index * 80}px)`;
                });
            }
        }, 300);
    });
}
</script>

{% endblock %}